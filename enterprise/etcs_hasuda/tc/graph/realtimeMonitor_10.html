<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム表示</title>

    <!-- CSS読み込み -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <!-- 外部CSSファイルの読み込み -->
    <link rel="stylesheet" href="realtimeMonitor.css">
    <!-- Chart.jsの読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJSライブラリの読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
    <!-- bootstrap js読み込み -->
    <script src="./js/bootstrap.bundle.min.js"></script>

    <div class="container my-4">
        <h2 class="text-center my-3">ＥＴＣトラカン リアルタイムモニター</h2>

        <!-- ボタングループ -->
        <div class="btn-group-real-time">
            <button class="btn btn-primary btn-real-time" onclick="changeView('group1')">休憩施設利用状況</button>
            <button class="btn btn-warning btn-real-time"
                style="background-color: #e67e22; border-color: #e67e22; color:white;"
                onclick="changeView('group3')">休憩施設
                長時間駐車台数</button>
            <button class="btn btn-secondary btn-real-time" onclick="changeView('group2')">道路交通観測</button>
        </div>

        <!-- グラフ表示エリア -->
        <div class="card">
            <div class="card-body">
                <!-- メインタイトルと時間切り替えボタン -->
                <div class="main-title-container">
                    <div class="main-title-content">
                        <h5 class="main-title" id="main-title">○○自動車道△△SA / 利用状況 2025年10月4日 <span
                                class="time-type-large time-type-24h">時間帯別表示</span></h5>
                        <div class="current-time" id="update-info">現在時刻: <span id="last-update">--:--:--</span></div>
                    </div>
                    <div class="time-switcher-container">
                        <button class="btn-time-switcher active" onclick="changeTimeType('24h')">時間帯別表示</button>
                        <button class="btn-time-switcher" onclick="changeTimeType('dayOfWeek')">曜日別表示</button>
                    </div>
                </div>

                <div class="charts-container" id="charts-container">
                    <!-- グラフはJavaScriptで動的に生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // チャートオブジェクトを管理する配列
        let chartInstances = [];
        let currentDisplayMode = 'group1'; // 現在の表示モード
        let currentTimeDisplayType = '24h'; // 現在の時間タイプ（24h or dayOfWeek）
        let timeUpdateInterval; // 時間更新用のインターバル
        let chartUpdateInterval; // グラフ更新用のインターバル
        let lastUpdateTime = null; // 最終更新時刻

        // 各グラフの最新データを保持するオブジェクト
        let chartLatestData = {
            // 休憩施設利用状況
            // 時間帯別データ
            smallInflowsCountByHour: { labels: [], data: [] },
            largeInflowsCountByHour: { labels: [], data: [] },
            smallStayTimeByHour: { labels: [], data: [] },
            largeStayTimeByHour: { labels: [], data: [] },
            // 曜日別データ
            smallInflowsCounByDay: { labels: [], data: [] },
            largeInflowsCountByDay: { labels: [], data: [] },
            smallStayTimeByDay: { labels: [], data: [] },
            largeStayTimeByDay: { labels: [], data: [] },
            // 道路交通観測
            // 時間帯別データ
            smallTrafficCountByHour: { labels: [], data: [] },
            largeTrafficCountByHour: { labels: [], data: [] },
            smallAverageSpeedByHour: { labels: [], data: [] },
            largeAverageSpeedByHour: { labels: [], data: [] },
            // 曜日別データ
            smallTrafficCountByDay: { labels: [], data: [] },
            largeTrafficCountByDay: { labels: [], data: [] },
            smallAverageSpeedByDay: { labels: [], data: [] },
            largeAverageSpeedByDay: { labels: [], data: [] },
            // 長時間駐車台数
            // 時間帯別データ
            smallLongParkingByHour: { labels: [], data: [] },
            largeLongParkingByHour: { labels: [], data: [] },
            // 曜日別データ
            smallLongParkingByDay: { labels: [], data: [] },
            largeLongParkingByDay: { labels: [], data: [] }
        };

        // 累計データを保持するオブジェクト
        let totalCounts = {
            // 休憩施設利用状況
            // 24時間別累計
            smallMain: 0,
            largeMain: 0,
            // 曜日別累計
            smallDay: 0,
            largeDay: 0,
            smallDayStayTime: 0,  // 小型車滞在時間
            largeDayStayTime: 0,  // 大型車滞在時間
            // 長時間駐車台数
            longParkingSmall: 0,
            longParkingLarge: 0,
            longParkingDaySmall: 0,
            longParkingDayLarge: 0,
            // 道路交通観測
            // 24時間別累計
            trafficSmall: 0, // 小型車通過台数
            trafficLarge: 0, // 大型車通過台数
            averageSpeedSmall: 0,
            averageSpeedLarge: 0,
            // 曜日別累計
            trafficDaySmall: 0, // 小型車通過台数
            trafficDayLarge: 0, // 大型車通過台数
            averageSpeedDaySmall: 0,  // 小型車平均速度
            averageSpeedDayLarge: 0   // 大型車平均速度
        };

        // Excelの生データを保持する変数
        // 休憩施設利用状況
        // 24時間別
        let excelData = null;
        let excelRawData = []; // 小型車通過台数
        let excelRawDataLarge = []; // 大型車通過台数
        let excelStayTimeData = []; // 小型車滞在時間
        let excelLargeStayTimeData = []; // 大型車滞在時間
        // 曜日別
        let excelDayData = []; // 小型車通過台数
        let excelDayDataLarge = []; // 大型車通過台数
        let excelDayStayTimeData = [];        // 小型車滞在時間
        let excelDayStayTimeDataLarge = [];   // 大型車滞在時間
        // 道路交通観測
        // 24時間別
        let excelTrafficSmallData = []; // 小型車通過台数
        let excelTrafficLargeData = []; // 大型車通過台数
        let excelAverageSpeedSmallData = []; // 小型車平均速度
        let excelAverageSpeedLargeData = []; // 大型車平均速度
        // 曜日別
        let excelTrafficDaySmallData = []; // 小型車通過台数
        let excelTrafficDayLargeData = []; // 大型車通過台数
        let excelAverageSpeedDaySmallData = []; // 小型車平均速度
        let excelAverageSpeedDayLargeData = []; // 大型車平均速度

        // 過去の処理済みのデータを保持する変数
        // 休憩施設利用状況
        // 24時間別
        let processedData = []; // 小型車通過台数
        let processedDataLarge = []; // 大型車通過台数
        let processedStayTimeData = []; // 小型車滞在時間
        let processedLargeStayTimeData = []; // 大型車滞在時間
        // 曜日別
        let processedDayData = []; // 小型車通過台数
        let processedDayDataLarge = []; // 大型車通過台数
        let processedDayStayTimeData = [];    // 小型車滞在時間
        let processedDayStayTimeDataLarge = []; // 大型車滞在時間
        // 道路交通観測
        // 24時間別
        let processedTrafficSmallData = []; // 小型車通過台数
        let processedTrafficLargeData = []; // 大型車通過台数
        let processedAverageSpeedSmallData = []; // 処理済み小型車平均速度データ
        let processedAverageSpeedLargeData = []; // 処理済み大型車平均速度データ
        // 曜日別
        let processedTrafficDaySmallData = []; // 小型車通過台数
        let processedTrafficDayLargeData = []; // 大型車通過台数
        let processedAverageSpeedDaySmallData = []; // 小型車平均速度
        let processedAverageSpeedDayLargeData = []; // 大型車平均速度

        // 次に処理するデータのインデックスを保持する変数
        // 休憩施設利用状況
        // 24時間別
        let nextDataIndex = 0; // 小型車通過台数
        let nextDataIndexLarge = 0; // 大型車通過台数
        let nextStayTimeDataIndex = 0; // 小型車滞在時間
        let nextLargeStayTimeDataIndex = 0; // 大型車滞在時間
        // 曜日別
        let nextDayDataIndex = 0; // 小型車通過台数
        let nextDayDataIndexLarge = 0; // 大型車通過台数
        let nextDayStayTimeDataIndex = 0;     // 小型車滞在時間
        let nextDayStayTimeDataIndexLarge = 0; // 大型車滞在時間
        // 道路交通観測
        // 24時間別
        let nextTrafficSmallDataIndex = 0; // 小型車通過台数
        let nextTrafficLargeDataIndex = 0; // 大型車通過台数
        let nextAverageSpeedSmallDataIndex = 0; // 小型車平均速度
        let nextAverageSpeedLargeDataIndex = 0; // 大型車平均速度
        // 曜日別
        let nextTrafficDaySmallDataIndex = 0; // 小型車通過台数
        let nextTrafficDayLargeDataIndex = 0; // 大型車通過台数
        let nextAverageSpeedDaySmallDataIndex = 0; // 小型車平均速度
        let nextAverageSpeedDayLargeDataIndex = 0; // 大型車平均速度

        // 長時間駐車台数のデータを初期化する関数
        function initializeLongParkingData() {
            // 小型車長時間駐車台数データ
            const smallParkingData = {
                labels: [
                    '0-1時間', '1-2時間', '2-3時間', '3-4時間', '4-5時間', '5-6時間',
                    '6-7時間', '7-8時間', '8-9時間', '9-10時間', '10-11時間', '11-12時間',
                    '12-13時間', '13-14時間', '14-15時間', '15-16時間', '16-17時間', '17-18時間',
                    '18-19時間', '19-20時間', '20-21時間', '21-22時間', '22-23時間', '23-24時間'
                ],
                data: [
                    763, 1853, 1134, 719, 418, 221, 148, 83, 56, 31, 22, 10,
                    34, 10, 9, 12, 2, 4, 5, 2, 5, 4, 2, 1
                ]
            };

            // 大型車長時間駐車台数データ
            const largeParkingData = {
                labels: [
                    '0-1時間', '1-2時間', '2-3時間', '3-4時間', '4-5時間', '5-6時間',
                    '6-7時間', '7-8時間', '8-9時間', '9-10時間', '10-11時間', '11-12時間',
                    '12-13時間', '13-14時間', '14-15時間', '15-16時間', '16-17時間', '17-18時間',
                    '18-19時間', '19-20時間', '20-21時間', '21-22時間', '22-23時間', '23-24時間'
                ],
                data: [
                    59, 95, 148, 94, 33, 16, 22, 19, 10, 5, 9, 1,
                    6, 3, 6, 3, 6, 2, 2, 7, 2, 8, 1, 2
                ]
            };

            // データをlatestDataに設定
            chartLatestData.smallLongParkingByHour = smallParkingData;
            chartLatestData.largeLongParkingByHour = largeParkingData;

            // 累計を計算
            totalCounts.longParkingSmall = smallParkingData.data.reduce((a, b) => a + b, 0);
            totalCounts.longParkingLarge = largeParkingData.data.reduce((a, b) => a + b, 0);

            // 曜日別データも同様に設定（サンプルデータ）
            chartLatestData.smallLongParkingByDay = {
                labels: generateDynamicDayOrder(),
                data: Array(7).fill(0).map(() => Math.floor(Math.random() * 1000))
            };
            chartLatestData.largeLongParkingByDay = {
                labels: generateDynamicDayOrder(),
                data: Array(7).fill(0).map(() => Math.floor(Math.random() * 100))
            };

            totalCounts.longParkingDaySmall = chartLatestData.smallLongParkingByDay.data.reduce((a, b) => a + b, 0);
            totalCounts.longParkingDayLarge = chartLatestData.largeLongParkingByDay.data.reduce((a, b) => a + b, 0);
        }

        // 曜日の順序を定義
        const dayOrder = ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日', '日曜日'];

        // 曜日を数値に変換する関数
        function dayToNumber(day) {
            return dayOrder.indexOf(day);
        }

        // 曜日と時刻を結合してDateオブジェクトに変換する関数
        function parseDayTimeString(dayString, timeString) {
            // 曜日を数値に変換（月曜日=0, 日曜日=6）
            const dayIndex = dayToNumber(dayString);

            // 現在の日付を取得
            const now = new Date();
            const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 日曜日調整

            // 週の開始を月曜日とするための調整
            // 月曜日(0)から現在の曜日までのデータを表示
            let dayDiff = dayIndex - 0; // 月曜日を起点

            // 日付を計算（月曜日を起点に加算）
            const targetDate = new Date(now);
            targetDate.setDate(now.getDate() - currentDayIndex + dayDiff); // 月曜日を起点に調整

            // 時刻を設定
            const [hours, minutes, seconds] = timeString.split(':').map(Number);
            targetDate.setHours(hours, minutes, seconds, 0);

            return targetDate;
        }

        // 通常の時間（0-23）を21時起点のインデックス（0-23）に変換
        function getShiftedHourIndex(hour) {
            return (hour + 3) % 24; // 21時を0インデックスにする（21-0=3時間シフト）
        }

        // 21時起点のインデックスを表示用の時間に変換
        function getDisplayHour(shiftedIndex) {
            return (21 + shiftedIndex) % 24;
        }

        // 表示モード切り替え
        function changeView(viewType) {
            currentDisplayMode = viewType;
            updateMainTitle();
            renderAllCharts();
            resetChartUpdateTimer(); // タイマーリセット
        }

        // メインタイトルを更新
        function updateMainTitle() {
            const titleElem = document.getElementById("main-title");
            const currentDate = getCurrentDateString();
            const timeTypeText = currentTimeDisplayType === '24h' ? '時間帯別表示' : '曜日別表示';
            const timeTypeClass = currentTimeDisplayType === '24h' ? 'time-type-24h' : 'time-type-day';

            if (currentDisplayMode === 'group1') {
                titleElem.innerHTML = `○○自動車道△△SA / 利用状況 ${currentDate} <span class="time-type-large ${timeTypeClass}">${timeTypeText}</span>`;
            } else if (currentDisplayMode === 'group3') {
                titleElem.innerHTML = `○○自動車道△△SA / 長時間駐車台数 ${currentDate} <span class="time-type-large ${timeTypeClass}">${timeTypeText}</span>`;
            } else {
                titleElem.innerHTML = `□□号 / 道路交通観測 ${currentDate} <span class="time-type-large ${timeTypeClass}">${timeTypeText}</span>`;
            }
        }

        // 現在の日付をフォーマットして返す
        function getCurrentDateString() {
            const now = new Date();
            return `${now.getFullYear()}年${(now.getMonth() + 1).toString().padStart(2, '0')}月${now.getDate().toString().padStart(2, '0')}日`;
        }

        // 時間タイプ切り替え
        function changeTimeType(timeType) {
            currentTimeDisplayType = timeType;

            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.btn-time-switcher').forEach(btn => {
                btn.classList.remove('active');
            });

            document.querySelectorAll('.btn-time-switcher').forEach(btn => {
                if (btn.textContent.includes(timeType === '24h' ? '時間帯別' : '曜日別')) {
                    btn.classList.add('active');
                }
            });

            // メインタイトルを更新（色も変更される）
            updateMainTitle();
            renderAllCharts();
            resetChartUpdateTimer(); // タイマーリセット
        }

        // 現在時刻をフォーマットして返す（秒付き）
        function getCurrentTimeString() {
            const now = new Date();
            return `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        }

        // 現在時刻を更新する関数
        function updateCurrentTime() {
            const timeDisplay = document.getElementById('time-display');
            if (timeDisplay) {
                const now = new Date();
                timeDisplay.textContent = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            }
        }

        // グラフ更新タイマーをリセット
        function resetChartUpdateTimer() {
            if (chartUpdateInterval) {
                clearInterval(chartUpdateInterval);
            }

            // 1秒ごとにグラフを更新
            chartUpdateInterval = setInterval(() => {
                updateAllCharts();
            }, 1000); // 1000ms = 1秒
        }

        // 時間文字列をDateオブジェクトに変換
        function parseTimeString(timeString, baseDate) {
            const [hours, minutes, seconds] = timeString.split(':').map(Number);
            const date = new Date(baseDate);
            date.setHours(hours, minutes, seconds, 0);
            return date;
        }

        // 滞在時間を分単位に変換
        function timeStringToMinutes(timeString) {
            const [hours, minutes, seconds] = timeString.split(':').map(Number);
            return hours * 60 + minutes + Math.round(seconds / 60);
        }

        // 現在の日付をフォーマットして返す
        function getCurrentDateString() {
            const now = new Date();
            return `${now.getFullYear()}年${(now.getMonth() + 1).toString().padStart(2, '0')}月${now.getDate().toString().padStart(2, '0')}日`;
        }

        // 日付表示を更新する関数
        function updateCurrentDate() {
            const dateDisplay = document.getElementById('current-date');
            if (dateDisplay) {
                dateDisplay.textContent = getCurrentDateString();
            }
        }

        // データを21時起点に再配置する関数
        function shiftDataTo21Start(data) {
            if (!data || !Array.isArray(data)) return Array(24).fill(0);

            const shiftedData = Array(24).fill(0);
            for (let originalHour = 0; originalHour < 24; originalHour++) {
                const shiftedIndex = getShiftedHourIndex(originalHour);
                if (originalHour < data.length) {
                    shiftedData[shiftedIndex] = data[originalHour];
                }
            }
            return shiftedData;
        }







        // 曜日の順序を動的に生成する関数（最新の曜日を右端に配置）
        function generateDynamicDayOrder() {
            const now = new Date();
            const currentDayIndex = now.getDay(); // 0:日曜日, 1:月曜日, ..., 6:土曜日

            // 曜日の配列（日曜日始まり）
            const days = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];

            // 現在の曜日を右端に配置するように配列を再構成
            const dynamicOrder = [];
            for (let i = currentDayIndex + 1; i < 7; i++) {
                dynamicOrder.push(days[i]);
            }
            for (let i = 0; i <= currentDayIndex; i++) {
                dynamicOrder.push(days[i]);
            }

            return dynamicOrder;
        }

        // 曜日を動的な順序のインデックスに変換する関数
        function dayToDynamicIndex(day) {
            const dynamicOrder = generateDynamicDayOrder();
            return dynamicOrder.indexOf(day);
        }

        // 曜日と時刻を結合してDateオブジェクトに変換する関数（動的順序対応）
        function parseDayTimeStringDynamic(dayString, timeString) {
            const dynamicOrder = generateDynamicDayOrder();
            const dayIndex = dynamicOrder.indexOf(dayString);

            // 現在の日付を取得
            const now = new Date();
            const currentDayIndex = now.getDay(); // 0:日曜日, 1:月曜日, ..., 6:土曜日

            // 動的順序での現在の曜日のインデックス
            const currentDynamicIndex = dynamicOrder.indexOf(['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'][currentDayIndex]);

            // 日付を計算（動的順序に基づいて調整）
            const targetDate = new Date(now);
            const dayDiff = dayIndex - currentDynamicIndex;
            targetDate.setDate(now.getDate() + dayDiff);

            // 時刻を設定
            const [hours, minutes, seconds] = timeString.split(':').map(Number);
            targetDate.setHours(hours, minutes, seconds, 0);

            return targetDate;
        }







        // Excelファイルを読み込む関数（小型車通過台数用）
        function loadExcelData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定（新しいファイルに変更）
                const filename = '251017_24時間別統計_小型_通過台数.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelRawData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 6) {
                                const dateStr = row[0]; // 日付
                                const timeStr = row[1]; // 時刻
                                const antenna = row[2]; // アンテナ番号
                                const wcn = row[3]; // WCN
                                const carType = row[4]; // 車種
                                const timeRange = row[5]; // 時間帯

                                // 昨日の21時から23時までと今日の0時以降で場合分け
                                if (timeStr.substring(0, 2) === "21" || timeStr.substring(0, 2) === "22" || timeStr.substring(0, 2) === "23") {
                                    // 現在の日時を取得
                                    const yesterday = new Date();
                                    // 日付を1日前に設定
                                    yesterday.setDate(yesterday.getDate() - 1);
                                    excelRawData.push({
                                        date: dateStr,
                                        time: timeStr,
                                        fullDateTime: parseTimeString(timeStr, yesterday),
                                        antenna: antenna,
                                        wcn: wcn,
                                        carType: carType,
                                        timeRange: timeRange
                                    });
                                } else {
                                    // // 現在の日付をベースに時刻をDateオブジェクトに変換
                                    const now = new Date();
                                    // const fullDateTime = parseTimeString(timeStr, now);
                                    excelRawData.push({
                                        date: dateStr,
                                        time: timeStr,
                                        fullDateTime: parseTimeString(timeStr, now),
                                        antenna: antenna,
                                        wcn: wcn,
                                        carType: carType,
                                        timeRange: timeRange
                                    });
                                }
                            }
                        }

                        // 時刻でソート
                        excelRawData.sort((a, b) => a.fullDateTime - b.fullDateTime);

                        // データを処理して時間帯別のカウントを行う
                        processExcelData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（大型車通過台数用）
        function loadExcelDataLarge() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定
                const filename = '251017_24時間別統計_大型_通過台数.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelRawDataLarge = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 6) {
                                const dateStr = row[0]; // 日付
                                const timeStr = row[1]; // 時刻
                                const antenna = row[2]; // アンテナ番号
                                const wcn = row[3]; // WCN
                                const carType = row[4]; // 車種
                                const timeRange = row[5]; // 時間帯

                                // 昨日の21時から23時までと今日の0時以降で場合分け
                                if (timeStr.substring(0, 2) === "21" || timeStr.substring(0, 2) === "22" || timeStr.substring(0, 2) === "23") {
                                    // 現在の日時を取得
                                    const yesterday = new Date();
                                    // 日付を1日前に設定
                                    yesterday.setDate(yesterday.getDate() - 1);
                                    excelRawDataLarge.push({
                                        date: dateStr,
                                        time: timeStr,
                                        fullDateTime: parseTimeString(timeStr, yesterday),
                                        antenna: antenna,
                                        wcn: wcn,
                                        carType: carType,
                                        timeRange: timeRange
                                    });
                                } else {
                                    // // 現在の日付をベースに時刻をDateオブジェクトに変換
                                    const now = new Date();
                                    // const fullDateTime = parseTimeString(timeStr, now);
                                    excelRawDataLarge.push({
                                        date: dateStr,
                                        time: timeStr,
                                        fullDateTime: parseTimeString(timeStr, now),
                                        antenna: antenna,
                                        wcn: wcn,
                                        carType: carType,
                                        timeRange: timeRange
                                    });
                                }
                            }
                        }

                        // 時刻でソート
                        excelRawDataLarge.sort((a, b) => a.fullDateTime - b.fullDateTime);

                        // データを処理して時間帯別のカウントを行う
                        processExcelDataLarge().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（小型車滞在時間用）
        function loadExcelStayTimeData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定
                const filename = '251017_24時間別統計_小型_滞在時間.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイル的読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // 滞在時間データを処理
                        const stayTimeData = [];
                        const labels = [];
                        const dataValues = [];

                        // 1行目は時間帯ラベル
                        if (jsonData.length > 0) {
                            for (let i = 0; i < 24; i++) {
                                if (i < jsonData[0].length) {
                                    labels.push(jsonData[0][i]);
                                } else {
                                    labels.push(`${i}時台`);
                                }
                            }
                        }

                        // 2行目は滞在時間データ
                        if (jsonData.length > 1) {
                            for (let i = 0; i < 24; i++) {
                                if (i < jsonData[1].length) {
                                    const timeString = jsonData[1][i];
                                    dataValues.push(timeStringToMinutes(timeString));
                                } else {
                                    dataValues.push(0);
                                }
                            }
                        }

                        // データを保存
                        excelStayTimeData = {
                            labels: labels,
                            data: dataValues
                        };

                        // 現在時刻に基づいてデータを処理
                        processStayTimeData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（大型車滞在時間用）
        function loadExcelLargeStayTimeData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定
                const filename = '251017_24時間別統計_大型_滞在時間.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイル的読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // 滞在時間データを処理
                        const stayTimeData = [];
                        const labels = [];
                        const dataValues = [];

                        // 1行目は時間帯ラベル
                        if (jsonData.length > 0) {
                            for (let i = 0; i < 24; i++) {
                                if (i < jsonData[0].length) {
                                    labels.push(jsonData[0][i]);
                                } else {
                                    labels.push(`${i}時台`);
                                }
                            }
                        }

                        // 2行目は滞在時間データ
                        if (jsonData.length > 1) {
                            for (let i = 0; i < 24; i++) {
                                if (i < jsonData[1].length) {
                                    const timeString = jsonData[1][i];
                                    dataValues.push(timeStringToMinutes(timeString));
                                } else {
                                    dataValues.push(0);
                                }
                            }
                        }

                        // データを保存
                        excelLargeStayTimeData = {
                            labels: labels,
                            data: dataValues
                        };

                        // 現在時刻に基づいてデータを処理
                        processLargeStayTimeData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（曜日別小型車通過台数用）- 日付マッピング対応
        function loadExcelDayData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定
                const filename = '曜日別統計_小型_通過台数.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelDayData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 5) {
                                const dayStr = row[0]; // 曜日
                                const timeStr = row[1]; // 時刻
                                const antenna = row[2]; // アンテナ番号
                                const wcn = row[3]; // WCN
                                const carType = row[4]; // 車種

                                // 日付マッピングを使用してDateオブジェクトに変換
                                const fullDateTime = parseDayTimeStringWithDate(dayStr, timeStr);

                                excelDayData.push({
                                    day: dayStr,
                                    time: timeStr,
                                    fullDateTime: fullDateTime,
                                    antenna: antenna,
                                    wcn: wcn,
                                    carType: carType
                                });
                            }
                        }

                        // 日時でソート
                        excelDayData.sort((a, b) => a.fullDateTime - b.fullDateTime);

                        // デバッグ情報表示
                        debugDayDateMapping();

                        // データを処理して曜日別のカウントを行う
                        processExcelDayData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（曜日別大型車通過台数用）- 日付マッピング対応
        function loadExcelDayDataLarge() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定
                const filename = '曜日別表示_大型車_通過台数.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelDayDataLarge = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 5) {
                                const dayStr = row[0]; // 曜日
                                const timeStr = row[1]; // 時刻
                                const antenna = row[2]; // アンテナ番号
                                const wcn = row[3]; // WCN
                                const carType = row[4]; // 車種

                                // 日付マッピングを使用してDateオブジェクトに変換
                                const fullDateTime = parseDayTimeStringWithDate(dayStr, timeStr);

                                excelDayDataLarge.push({
                                    day: dayStr,
                                    time: timeStr,
                                    fullDateTime: fullDateTime,
                                    antenna: antenna,
                                    wcn: wcn,
                                    carType: carType
                                });
                            }
                        }

                        // 日時でソート
                        excelDayDataLarge.sort((a, b) => a.fullDateTime - b.fullDateTime);

                        // データを処理して曜日別のカウントを行う
                        processExcelDayDataLarge().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（曜日別小型車滞在時間用）
        function loadExcelDayStayTimeData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定
                const filename = '曜日別統計_小型_滞在時間.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelDayStayTimeData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const dayStr = row[0]; // 曜日
                                const timeStr = row[1]; // 滞在時間の中央値

                                // 滞在時間を分単位に変換
                                const stayTimeMinutes = timeStringToMinutes(timeStr);

                                excelDayStayTimeData.push({
                                    day: dayStr,
                                    stayTime: stayTimeMinutes,
                                    timeString: timeStr
                                });
                            }
                        }

                        // データを処理して曜日別の滞在時間を生成
                        processExcelDayStayTimeData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（曜日別大型車滞在時間用）
        function loadExcelDayStayTimeDataLarge() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定
                const filename = '曜日別統計_大型_滞在時間.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelDayStayTimeDataLarge = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const dayStr = row[0]; // 曜日
                                const timeStr = row[1]; // 滞在時間の中央値

                                // 滞在時間を分単位に変換
                                const stayTimeMinutes = timeStringToMinutes(timeStr);

                                excelDayStayTimeDataLarge.push({
                                    day: dayStr,
                                    stayTime: stayTimeMinutes,
                                    timeString: timeStr
                                });
                            }
                        }

                        // データを処理して曜日別の滞在時間を生成
                        processExcelDayStayTimeDataLarge().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // 道路交通観測Excelファイル読み込み
        // Excelファイルを読み込む関数（小型車通過台数用）
        function loadExcelTrafficSmallData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定（添付したExcelファイル名に合わせて変更）
                const filename = '道路交通観測_24時間別統計_小型_通過台数_10月16日分.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelTrafficSmallData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const timeStr = row[1]; // time列（B列）

                                // 現在の日付をベースに時刻をDateオブジェクトに変換
                                const now = new Date();
                                const fullDateTime = parseTimeString(timeStr, now);

                                excelTrafficSmallData.push({
                                    time: timeStr,
                                    fullDateTime: fullDateTime
                                });
                            }
                        }

                        // 時刻でソート
                        excelTrafficSmallData.sort((a, b) => a.fullDateTime - b.fullDateTime);

                        // データを処理して時間帯別のカウントを行う
                        processExcelTrafficSmallData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（小型車平均速度用）
        function loadExcelAverageSpeedSmallData() {
            return new Promise((resolve, reject) => {
                const filename = '道路交通観測_24時間別統計_小型_10月16日分_平均速度中央値.xlsx';

                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // データ処理（ヘッダー行をスキップ）
                        excelAverageSpeedSmallData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const timeRange = row[0]; // 時間帯
                                const averageSpeed = row[1]; // 平均速度の中央値

                                excelAverageSpeedSmallData.push({
                                    timeRange: timeRange,
                                    averageSpeed: averageSpeed
                                });
                            }
                        }

                        // データを処理
                        processExcelAverageSpeedSmallData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（大型車通過台数用）
        function loadExcelTrafficLargeData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定（添付したExcelファイル名に合わせて変更）
                const filename = '道路交通観測_24時間別統計_大型_通過台数_10月16日分.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelTrafficLargeData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const timeStr = row[1]; // time列（B列）

                                // 現在の日付をベースに時刻をDateオブジェクトに変換
                                const now = new Date();
                                const fullDateTime = parseTimeString(timeStr, now);

                                excelTrafficLargeData.push({
                                    time: timeStr,
                                    fullDateTime: fullDateTime
                                });
                            }
                        }

                        // 時刻でソート
                        excelTrafficLargeData.sort((a, b) => a.fullDateTime - b.fullDateTime);

                        // データを処理して時間帯別のカウントを行う
                        processExcelTrafficLargeData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（大型車平均速度用）
        function loadExcelAverageSpeedLargeData() {
            return new Promise((resolve, reject) => {
                const filename = '道路交通観測_24時間別統計_大型_10月16日分_平均速度中央値.xlsx';

                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // データ処理（ヘッダー行をスキップ）
                        excelAverageSpeedLargeData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const timeRange = row[0]; // 時間帯
                                const averageSpeed = row[1]; // 平均速度の中央値

                                excelAverageSpeedLargeData.push({
                                    timeRange: timeRange,
                                    averageSpeed: averageSpeed
                                });
                            }
                        }

                        // データを処理
                        processExcelAverageSpeedLargeData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（曜日別小型車通過台数用）- 道路交通観測、日付マッピング対応
        function loadExcelTrafficDaySmallData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定（添付したExcelファイル名に合わせて変更）
                const filename = '１号機_架空データ_1週間分_小型.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelTrafficDaySmallData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 3) {
                                const dayStr = row[1]; // week列（B列）
                                const timeStr = row[2]; // time列（C列）

                                // 日付マッピングを使用してDateオブジェクトに変換
                                const fullDateTime = parseDayTimeStringWithDate(dayStr, timeStr);

                                excelTrafficDaySmallData.push({
                                    day: dayStr,
                                    time: timeStr,
                                    fullDateTime: fullDateTime
                                });
                            }
                        }

                        // 日時でソート
                        excelTrafficDaySmallData.sort((a, b) => a.fullDateTime - b.fullDateTime);

                        // データを処理して曜日別のカウントを行う
                        processExcelTrafficDaySmallData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（曜日別小型車平均速度用）
        function loadExcelAverageSpeedDaySmallData() {
            return new Promise((resolve, reject) => {
                const filename = '道路交通観測_曜日別統計_小型_平均速度の中央値.xlsx';

                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // データ処理（ヘッダー行をスキップ）
                        excelAverageSpeedDaySmallData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const dayStr = row[0]; // 曜日
                                const averageSpeed = row[1]; // 平均速度の中央値

                                excelAverageSpeedDaySmallData.push({
                                    day: dayStr,
                                    averageSpeed: averageSpeed
                                });
                            }
                        }

                        // データを処理
                        processExcelAverageSpeedDaySmallData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（曜日別大型車通過台数用）- 道路交通観測、日付マッピング対応
        function loadExcelTrafficDayLargeData() {
            return new Promise((resolve, reject) => {
                // ファイル名を指定（添付したExcelファイル名に合わせて変更）
                const filename = '１号機_架空データ_1週間分_大型.xlsx';

                // ファイルを取得
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        // Excelデータを解析
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // シート名を取得（最初のシートを使用）
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];

                        // JSON形式に変換
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // ヘッダー行をスキップしてデータを処理
                        excelTrafficDayLargeData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 3) {
                                const dayStr = row[1]; // week列（B列）
                                const timeStr = row[2]; // time列（C列）

                                // 日付マッピングを使用してDateオブジェクトに変換
                                const fullDateTime = parseDayTimeStringWithDate(dayStr, timeStr);

                                excelTrafficDayLargeData.push({
                                    day: dayStr,
                                    time: timeStr,
                                    fullDateTime: fullDateTime
                                });
                            }
                        }

                        // 日時でソート
                        excelTrafficDayLargeData.sort((a, b) => a.fullDateTime - b.fullDateTime);

                        // データを処理して曜日別のカウントを行う
                        processExcelTrafficDayLargeData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelファイルを読み込む関数（曜日別大型車平均速度用）
        function loadExcelAverageSpeedDayLargeData() {
            return new Promise((resolve, reject) => {
                const filename = '道路交通観測_曜日別統計_大型_平均速度の中央値.xlsx';

                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ファイルの読み込みに失敗しました');
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // データ処理（ヘッダー行をスキップ）
                        excelAverageSpeedDayLargeData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const dayStr = row[0]; // 曜日
                                const averageSpeed = row[1]; // 平均速度の中央値

                                excelAverageSpeedDayLargeData.push({
                                    day: dayStr,
                                    averageSpeed: averageSpeed
                                });
                            }
                        }

                        // データを処理
                        processExcelAverageSpeedDayLargeData().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    })
                    .catch(error => {
                        console.error('Excelファイルの読み込みエラー:', error);
                        reject(error);
                    });
            });
        }

        // Excelデータを処理して時間帯別カウントを生成（小型車通過台数用）
        function processExcelData() {
            return new Promise((resolve) => {
                const now = new Date();
                const hourlyCounts = Array(24).fill(0); // 0時起点の配列（一時的な保存用）
                processedData = [];

                // 累計をリセット
                totalCounts.smallMain = 0;

                // 現在時刻までのデータを処理
                for (let i = 0; i < excelRawData.length; i++) {
                    const data = excelRawData[i];

                    // 現在時刻より前のデータのみ処理
                    if (data.fullDateTime <= now) {
                        // 時間帯列から時間を抽出 (例: "0時台" → 0)
                        const hourMatch = data.timeRange.match(/(\d+)時台/);

                        if (hourMatch && hourMatch[1]) {
                            const originalHour = parseInt(hourMatch[1]);
                            if (originalHour >= 0 && originalHour < 24) {
                                // 0時起点で一時的にカウント
                                hourlyCounts[originalHour]++;
                                totalCounts.smallMain++;
                            }
                        }

                        // 処理済みデータとしてマーク
                        processedData.push(data);
                    } else {
                        // 未来のデータは次の処理対象としてインデックスを保存
                        nextDataIndex = i;
                        break;
                    }
                }

                // ★★★ データを21時起点に再配置 ★★★
                const shiftedHourlyCounts = shiftDataTo21Start(hourlyCounts);

                // 結果を返す
                resolve({
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: shiftedHourlyCounts // 21時起点のデータ
                });
            });
        }

        // Excelデータを処理して時間帯別カウントを生成（大型車通過台数用）
        function processExcelDataLarge() {
            return new Promise((resolve) => {
                const now = new Date();
                const hourlyCounts = Array(24).fill(0); // 0時起点の配列（一時的な保存用）
                processedDataLarge = [];

                // 累計をリセット
                totalCounts.largeMain = 0;

                // 現在時刻までのデータを処理
                for (let i = 0; i < excelRawDataLarge.length; i++) {
                    const data = excelRawDataLarge[i];

                    // 現在時刻より前のデータのみ処理
                    if (data.fullDateTime <= now) {
                        // 時間帯列から時間を抽出 (例: "0時台" → 0)
                        const hourMatch = data.timeRange.match(/(\d+)時台/);

                        if (hourMatch && hourMatch[1]) {
                            const originalHour = parseInt(hourMatch[1]);
                            if (originalHour >= 0 && originalHour < 24) {
                                // 0時起点で一時的にカウント
                                hourlyCounts[originalHour]++;
                                totalCounts.largeMain++;
                            }
                        }

                        // 処理済みデータとしてマーク
                        processedDataLarge.push(data);
                    } else {
                        // 未来のデータは次の処理対象としてインデックスを保存
                        nextDataIndexLarge = i;
                        break;
                    }
                }

                // ★★★ データを21時起点に再配置 ★★★
                const shiftedHourlyCounts = shiftDataTo21Start(hourlyCounts);

                // 結果を返す
                resolve({
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: shiftedHourlyCounts // 21時起点のデータ
                });
            });
        }

        // Excelデータを処理して滞在時間データを生成（小型車滞在時間用）
        function processStayTimeData() {
            return new Promise((resolve) => {
                const now = new Date();
                const currentHour = now.getHours();
                // ★★★ 21時起点で現在時刻の1つ前の時間帯を計算 ★★★
                const shiftedCurrentHour = getShiftedHourIndex(currentHour);
                const previousShiftedHour = shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1;

                const processedData = Array(24).fill(null);

                // 元データを21時起点に再配置
                for (let originalHour = 0; originalHour < 24; originalHour++) {
                    const shiftedIndex = getShiftedHourIndex(originalHour);
                    if (shiftedIndex < excelStayTimeData.data.length) {
                        // ★★★ 21時起点の位置にデータを配置 ★★★
                        processedData[shiftedIndex] = excelStayTimeData.data[originalHour];
                    }
                }

                // 現在時刻より後のデータはnullにする
                for (let i = previousShiftedHour + 1; i < 24; i++) {
                    processedData[i] = null;
                }

                // 結果を返す
                resolve({
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: processedData
                });
            });
        }

        // Excelデータを処理して滞在時間データを生成（大型車滞在時間用）
        function processLargeStayTimeData() {
            return new Promise((resolve) => {
                const now = new Date();
                const currentHour = now.getHours();
                // ★★★ 21時起点で現在時刻の1つ前の時間帯を計算 ★★★
                const shiftedCurrentHour = getShiftedHourIndex(currentHour);
                const previousShiftedHour = shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1;

                const processedData = Array(24).fill(null);

                // 元データを21時起点に再配置
                for (let originalHour = 0; originalHour < 24; originalHour++) {
                    const shiftedIndex = getShiftedHourIndex(originalHour);
                    if (shiftedIndex < excelLargeStayTimeData.data.length) {
                        // ★★★ 21時起点の位置にデータを配置 ★★★
                        processedData[shiftedIndex] = excelLargeStayTimeData.data[originalHour];
                    }
                }

                // 現在時刻より後のデータはnullにする
                for (let i = previousShiftedHour + 1; i < 24; i++) {
                    processedData[i] = null;
                }

                // 結果を返す
                resolve({
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: processedData
                });
            });
        }

        // 曜日と日付のマッピングを生成する関数
        function generateDayDateMapping() {
            const now = new Date();
            const dynamicOrder = generateDynamicDayOrder();

            const dayDateMap = {};

            // 各曜日の実際の日付を計算
            dynamicOrder.forEach((day, index) => {
                const date = new Date(now);
                // 最新の曜日（右端）が今日、左に行くほど過去
                const daysFromToday = index - (dynamicOrder.length - 1);
                date.setDate(now.getDate() + daysFromToday);
                dayDateMap[day] = new Date(date);
            });

            return dayDateMap;
        }

        // 曜日と時刻を結合してDateオブジェクトに変換する関数（日付マッピング使用）
        function parseDayTimeStringWithDate(dayString, timeString) {
            const dayDateMap = generateDayDateMapping();

            if (dayDateMap[dayString]) {
                const date = new Date(dayDateMap[dayString]);
                const [hours, minutes, seconds] = timeString.split(':').map(Number);
                date.setHours(hours, minutes, seconds, 0);
                return date;
            }

            // マッピングにない場合は現在の日付を使用
            return parseDayTimeStringDynamic(dayString, timeString);
        }

        // Excelデータを処理して曜日別カウントを生成（小型車通過台数用）- 日付マッピング対応
        function processExcelDayData() {
            return new Promise((resolve) => {
                const now = new Date();
                const dynamicOrder = generateDynamicDayOrder();
                const dayDateMap = generateDayDateMapping();

                // 動的順序に基づいてカウント用オブジェクトを初期化
                const dayCounts = {};
                dynamicOrder.forEach(day => {
                    dayCounts[day] = 0;
                });

                processedDayData = [];

                // 累計をリセット
                totalCounts.smallDay = 0;

                // 各曜日の日付範囲を設定（その曜日の0時から23時59分59秒まで）
                const dayDateRanges = {};
                dynamicOrder.forEach(day => {
                    const dayStart = new Date(dayDateMap[day]);
                    dayStart.setHours(0, 0, 0, 0);

                    const dayEnd = new Date(dayDateMap[day]);
                    dayEnd.setHours(23, 59, 59, 999);

                    dayDateRanges[day] = {
                        start: dayStart,
                        end: dayEnd
                    };
                });

                // 現在時刻までのデータを処理（日付マッピング対応）
                for (let i = 0; i < excelDayData.length; i++) {
                    const data = excelDayData[i];

                    // データの曜日が動的順序に含まれているか確認
                    if (dynamicOrder.includes(data.day)) {
                        // データの日時を日付マッピングで計算
                        const dataDateTime = parseDayTimeStringWithDate(data.day, data.time);
                        const dayRange = dayDateRanges[data.day];

                        // その曜日の日付範囲内かつ現在時刻までのデータのみ処理
                        if (dataDateTime >= dayRange.start && dataDateTime <= dayRange.end && dataDateTime <= now) {
                            // 曜日でカウント
                            dayCounts[data.day]++;
                            totalCounts.smallDay++;

                            // 処理済みデータとしてマーク
                            processedDayData.push({
                                ...data,
                                fullDateTime: dataDateTime // 実際の日時情報を保存
                            });
                        } else if (dataDateTime > dayRange.end) {
                            // 未来のデータは次の処理対象としてインデックスを保存
                            nextDayDataIndex = i;
                            break;
                        }
                    }
                }

                // 結果を返す（動的順序で並べ替え）
                const labels = dynamicOrder;
                const dataValues = labels.map(day => dayCounts[day]);

                resolve({
                    labels: labels,
                    data: dataValues
                });
            });
        }

        // Excelデータを処理して曜日別カウントを生成（大型車通過台数用）- 日付マッピング対応
        function processExcelDayDataLarge() {
            return new Promise((resolve) => {
                const now = new Date();
                const dynamicOrder = generateDynamicDayOrder();
                const dayDateMap = generateDayDateMapping();

                // 動的順序に基づいてカウント用オブジェクトを初期化
                const dayCounts = {};
                dynamicOrder.forEach(day => {
                    dayCounts[day] = 0;
                });

                processedDayDataLarge = [];

                // 累計をリセット
                totalCounts.largeDay = 0;

                // 各曜日の日付範囲を設定（その曜日の0時から23時59分59秒まで）
                const dayDateRanges = {};
                dynamicOrder.forEach(day => {
                    const dayStart = new Date(dayDateMap[day]);
                    dayStart.setHours(0, 0, 0, 0);

                    const dayEnd = new Date(dayDateMap[day]);
                    dayEnd.setHours(23, 59, 59, 999);

                    dayDateRanges[day] = {
                        start: dayStart,
                        end: dayEnd
                    };
                });

                // 現在時刻までのデータを処理（日付マッピング対応）
                for (let i = 0; i < excelDayDataLarge.length; i++) {
                    const data = excelDayDataLarge[i];

                    // データの曜日が動的順序に含まれているか確認
                    if (dynamicOrder.includes(data.day)) {
                        // データの日時を日付マッピングで計算
                        const dataDateTime = parseDayTimeStringWithDate(data.day, data.time);
                        const dayRange = dayDateRanges[data.day];

                        // その曜日の日付範囲内かつ現在時刻までのデータのみ処理
                        if (dataDateTime >= dayRange.start && dataDateTime <= dayRange.end && dataDateTime <= now) {
                            // 曜日でカウント
                            dayCounts[data.day]++;
                            totalCounts.largeDay++;

                            // 処理済みデータとしてマーク
                            processedDayDataLarge.push({
                                ...data,
                                fullDateTime: dataDateTime // 実際の日時情報を保存
                            });
                        } else if (dataDateTime > dayRange.end) {
                            // 未来のデータは次の処理対象としてインデックスを保存
                            nextDayDataIndexLarge = i;
                            break;
                        }
                    }
                }

                // 結果を返す（動的順序で並べ替え）
                const labels = dynamicOrder;
                const dataValues = labels.map(day => dayCounts[day]);

                resolve({
                    labels: labels,
                    data: dataValues
                });
            });
        }

        // Excelデータを処理して曜日別滞在時間を生成（小型車用）
        function processExcelDayStayTimeData() {
            return new Promise((resolve) => {
                const now = new Date();
                const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 月曜日=0
                // 現在の曜日より前の曜日のみ処理（例: 木曜日なら月〜水まで）
                const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;

                const dayStayTimes = {
                    '月曜日': null,
                    '火曜日': null,
                    '水曜日': null,
                    '木曜日': null,
                    '金曜日': null,
                    '土曜日': null,
                    '日曜日': null
                };
                processedDayStayTimeData = [];

                // 現在の曜日より前のデータのみ処理（月曜日起点）
                for (let i = 0; i < excelDayStayTimeData.length; i++) {
                    const data = excelDayStayTimeData[i];

                    // データの曜日インデックスを取得
                    const dataDayIndex = dayToNumber(data.day);

                    // 月曜日〜現在の曜日の前日までのデータのみ処理
                    // 例: 木曜日なら月曜日(0)〜水曜日(2)まで
                    if (dataDayIndex <= previousDayIndex) {
                        // 曜日で滞在時間を設定
                        if (dayStayTimes.hasOwnProperty(data.day)) {
                            dayStayTimes[data.day] = data.stayTime;
                        }

                        // 処理済みデータとしてマーク
                        processedDayStayTimeData.push(data);
                    } else {
                        // 現在の曜日以降のデータは次の処理対象としてインデックスを保存
                        nextDayStayTimeDataIndex = i;
                        break;
                    }
                }

                // 結果を返す（曜日順に並べ替え）
                const labels = dayOrder;
                const dataValues = labels.map(day => dayStayTimes[day]);

                resolve({
                    labels: labels,
                    data: dataValues
                });
            });
        }

        // Excelデータを処理して曜日別滞在時間を生成（大型車用）
        function processExcelDayStayTimeDataLarge() {
            return new Promise((resolve) => {
                const now = new Date();
                const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 月曜日=0
                // 現在の曜日より前の曜日のみ処理（例: 木曜日なら月〜水まで）
                const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;

                const dayStayTimes = {
                    '月曜日': null,
                    '火曜日': null,
                    '水曜日': null,
                    '木曜日': null,
                    '金曜日': null,
                    '土曜日': null,
                    '日曜日': null
                };
                processedDayStayTimeDataLarge = [];

                // 現在の曜日より前のデータのみ処理（月曜日起点）
                for (let i = 0; i < excelDayStayTimeDataLarge.length; i++) {
                    const data = excelDayStayTimeDataLarge[i];

                    // データの曜日インデックスを取得
                    const dataDayIndex = dayToNumber(data.day);

                    // 月曜日〜現在の曜日の前日までのデータのみ処理
                    // 例: 木曜日なら月曜日(0)〜水曜日(2)まで
                    if (dataDayIndex <= previousDayIndex) {
                        // 曜日で滞在時間を設定
                        if (dayStayTimes.hasOwnProperty(data.day)) {
                            dayStayTimes[data.day] = data.stayTime;
                        }

                        // 処理済みデータとしてマーク
                        processedDayStayTimeDataLarge.push(data);
                    } else {
                        // 現在の曜日以降のデータは次の処理対象としてインデックスを保存
                        nextDayStayTimeDataIndexLarge = i;
                        break;
                    }
                }

                // 結果を返す（曜日順に並べ替え）
                const labels = dayOrder;
                const dataValues = labels.map(day => dayStayTimes[day]);

                resolve({
                    labels: labels,
                    data: dataValues
                });
            });
        }

        // 道路交通観測Excelデータ処理
        // Excelデータを処理して時間帯別カウントを生成（小型車通過台数用）
        function processExcelTrafficSmallData() {
            return new Promise((resolve) => {
                const now = new Date();
                const hourlyCounts = Array(24).fill(0);
                processedTrafficSmallData = [];

                // 累計をリセット
                totalCounts.trafficSmall = 0;

                // 現在時刻までのデータを処理
                for (let i = 0; i < excelTrafficSmallData.length; i++) {
                    const data = excelTrafficSmallData[i];

                    // 現在時刻より前のデータのみ処理
                    if (data.fullDateTime <= now) {
                        // 時間帯を抽出（0-23時）
                        const hour = data.fullDateTime.getHours();
                        if (hour >= 0 && hour < 24) {
                            hourlyCounts[hour]++;
                            totalCounts.trafficSmall++;
                        }

                        // 処理済みデータとしてマーク
                        processedTrafficSmallData.push(data);
                    } else {
                        // 未来のデータは次の処理対象としてインデックスを保存
                        nextTrafficSmallDataIndex = i;
                        break;
                    }
                }

                // 結果を返す
                resolve({
                    labels: generateTimeRangeLabels(),
                    data: hourlyCounts
                });
            });
        }

        // Excelデータを処理して平均速度データを生成（小型車用）
        function processExcelAverageSpeedSmallData() {
            return new Promise((resolve) => {
                const now = new Date();
                const currentHour = now.getHours();
                // 現在時刻の1つ前の時間帯までを表示（例: 7時46分なら6時台まで）
                const displayHour = currentHour === 0 ? 23 : currentHour - 1;

                const processedData = Array(24).fill(null);
                processedAverageSpeedSmallData = [];

                // 現在時刻の1つ前の時間帯までのデータのみ処理
                for (let i = 0; i <= displayHour; i++) {
                    const data = excelAverageSpeedSmallData[i];
                    if (data) {
                        processedData[i] = data.averageSpeed;
                        processedAverageSpeedSmallData.push(data);
                    }
                }

                // 次の処理インデックスを設定
                nextAverageSpeedSmallDataIndex = displayHour + 1;

                // 最新の時間帯の値を保存（情報表示用）
                if (displayHour >= 0 && processedData[displayHour] !== null) {
                    totalCounts.averageSpeedSmall = processedData[displayHour];
                }

                resolve({
                    labels: generateTimeRangeLabels(),
                    data: processedData
                });
            });
        }

        // Excelデータを処理して時間帯別カウントを生成（大型車通過台数用）
        function processExcelTrafficLargeData() {
            return new Promise((resolve) => {
                const now = new Date();
                const hourlyCounts = Array(24).fill(0);
                processedTrafficLargeData = [];

                // 累計をリセット
                totalCounts.trafficLarge = 0;

                // 現在時刻までのデータを処理
                for (let i = 0; i < excelTrafficLargeData.length; i++) {
                    const data = excelTrafficLargeData[i];

                    // 現在時刻より前のデータのみ処理
                    if (data.fullDateTime <= now) {
                        // 時間帯を抽出（0-23時）
                        const hour = data.fullDateTime.getHours();
                        if (hour >= 0 && hour < 24) {
                            hourlyCounts[hour]++;
                            totalCounts.trafficLarge++;
                        }

                        // 処理済みデータとしてマーク
                        processedTrafficLargeData.push(data);
                    } else {
                        // 未来のデータは次の処理対象としてインデックスを保存
                        nextTrafficLargeDataIndex = i;
                        break;
                    }
                }

                // 結果を返す
                resolve({
                    labels: generateTimeRangeLabels(),
                    data: hourlyCounts
                });
            });
        }

        // Excelデータを処理して平均速度データを生成（大型車用）
        function processExcelAverageSpeedLargeData() {
            return new Promise((resolve) => {
                const now = new Date();
                const currentHour = now.getHours();
                // 現在時刻の1つ前の時間帯までを表示（例: 7時46分なら6時台まで）
                const displayHour = currentHour === 0 ? 23 : currentHour - 1;

                const processedData = Array(24).fill(null);
                processedAverageSpeedLargeData = [];

                // 現在時刻の1つ前の時間帯までのデータのみ処理
                for (let i = 0; i <= displayHour; i++) {
                    const data = excelAverageSpeedLargeData[i];
                    if (data) {
                        processedData[i] = data.averageSpeed;
                        processedAverageSpeedLargeData.push(data);
                    }
                }

                // 次の処理インデックスを設定
                nextAverageSpeedLargeDataIndex = displayHour + 1;

                // 最新の時間帯の値を保存（情報表示用）
                if (displayHour >= 0 && processedData[displayHour] !== null) {
                    totalCounts.averageSpeedLarge = processedData[displayHour];
                }

                resolve({
                    labels: generateTimeRangeLabels(),
                    data: processedData
                });
            });
        }

        // Excelデータを処理して曜日別カウントを生成（小型車通過台数用）- 道路交通観測、日付マッピング対応
        function processExcelTrafficDaySmallData() {
            return new Promise((resolve) => {
                const now = new Date();
                const dynamicOrder = generateDynamicDayOrder();
                const dayDateMap = generateDayDateMapping();

                // 動的順序に基づいてカウント用オブジェクトを初期化
                const dayCounts = {};
                dynamicOrder.forEach(day => {
                    dayCounts[day] = 0;
                });

                processedTrafficDaySmallData = [];

                // 累計をリセット
                totalCounts.trafficDaySmall = 0;

                // 各曜日の日付範囲を設定（その曜日の0時から23時59分59秒まで）
                const dayDateRanges = {};
                dynamicOrder.forEach(day => {
                    const dayStart = new Date(dayDateMap[day]);
                    dayStart.setHours(0, 0, 0, 0);

                    const dayEnd = new Date(dayDateMap[day]);
                    dayEnd.setHours(23, 59, 59, 999);

                    dayDateRanges[day] = {
                        start: dayStart,
                        end: dayEnd
                    };
                });

                // 現在時刻までのデータを処理（日付マッピング対応）
                for (let i = 0; i < excelTrafficDaySmallData.length; i++) {
                    const data = excelTrafficDaySmallData[i];

                    // データの曜日が動的順序に含まれているか確認
                    if (dynamicOrder.includes(data.day)) {
                        // データの日時を日付マッピングで計算
                        const dataDateTime = parseDayTimeStringWithDate(data.day, data.time);
                        const dayRange = dayDateRanges[data.day];

                        // その曜日の日付範囲内かつ現在時刻までのデータのみ処理
                        if (dataDateTime >= dayRange.start && dataDateTime <= dayRange.end && dataDateTime <= now) {
                            // 曜日でカウント
                            dayCounts[data.day]++;
                            totalCounts.trafficDaySmall++;

                            // 処理済みデータとしてマーク
                            processedTrafficDaySmallData.push({
                                ...data,
                                fullDateTime: dataDateTime // 実際の日時情報を保存
                            });
                        } else if (dataDateTime > dayRange.end) {
                            // 未来のデータは次の処理対象としてインデックスを保存
                            nextTrafficDaySmallDataIndex = i;
                            break;
                        }
                    }
                }

                // 結果を返す（動的順序で並べ替え）
                const labels = dynamicOrder;
                const dataValues = labels.map(day => dayCounts[day]);

                resolve({
                    labels: labels,
                    data: dataValues
                });
            });
        }

        // Excelデータを処理して曜日別平均速度データを生成（小型車用）
        function processExcelAverageSpeedDaySmallData() {
            return new Promise((resolve) => {
                const now = new Date();
                const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 月曜日=0
                // 現在の曜日より前の曜日のみ処理（例: 木曜日なら月〜水まで）
                const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;

                const dayAverageSpeeds = {
                    '月曜日': null,
                    '火曜日': null,
                    '水曜日': null,
                    '木曜日': null,
                    '金曜日': null,
                    '土曜日': null,
                    '日曜日': null
                };
                processedAverageSpeedDaySmallData = [];

                // 現在の曜日より前のデータのみ処理（月曜日起点）
                for (let i = 0; i < excelAverageSpeedDaySmallData.length; i++) {
                    const data = excelAverageSpeedDaySmallData[i];

                    // データの曜日インデックスを取得
                    const dataDayIndex = dayToNumber(data.day);

                    // 月曜日〜現在の曜日の前日までのデータのみ処理
                    // 例: 木曜日なら月曜日(0)〜水曜日(2)まで
                    if (dataDayIndex <= previousDayIndex) {
                        // 曜日で平均速度を設定
                        if (dayAverageSpeeds.hasOwnProperty(data.day)) {
                            dayAverageSpeeds[data.day] = data.averageSpeed;
                        }

                        // 処理済みデータとしてマーク
                        processedAverageSpeedDaySmallData.push(data);
                    } else {
                        // 現在の曜日以降のデータは次の処理対象としてインデックスを保存
                        nextAverageSpeedDaySmallDataIndex = i;
                        break;
                    }
                }

                // 最新の曜日の値を保存（情報表示用）
                if (previousDayIndex >= 0 && dayAverageSpeeds[dayOrder[previousDayIndex]] !== null) {
                    totalCounts.averageSpeedDaySmall = dayAverageSpeeds[dayOrder[previousDayIndex]];
                }

                // 結果を返す（曜日順に並べ替え）
                const labels = dayOrder;
                const dataValues = labels.map(day => dayAverageSpeeds[day]);

                resolve({
                    labels: labels,
                    data: dataValues
                });
            });
        }

        // Excelデータを処理して曜日別カウントを生成（大型車通過台数用）- 道路交通観測、日付マッピング対応
        function processExcelTrafficDayLargeData() {
            return new Promise((resolve) => {
                const now = new Date();
                const dynamicOrder = generateDynamicDayOrder();
                const dayDateMap = generateDayDateMapping();

                // 動的順序に基づいてカウント用オブジェクトを初期化
                const dayCounts = {};
                dynamicOrder.forEach(day => {
                    dayCounts[day] = 0;
                });

                processedTrafficDayLargeData = [];

                // 累計をリセット
                totalCounts.trafficDayLarge = 0;

                // 各曜日の日付範囲を設定（その曜日の0時から23時59分59秒まで）
                const dayDateRanges = {};
                dynamicOrder.forEach(day => {
                    const dayStart = new Date(dayDateMap[day]);
                    dayStart.setHours(0, 0, 0, 0);

                    const dayEnd = new Date(dayDateMap[day]);
                    dayEnd.setHours(23, 59, 59, 999);

                    dayDateRanges[day] = {
                        start: dayStart,
                        end: dayEnd
                    };
                });

                // 現在時刻までのデータを処理（日付マッピング対応）
                for (let i = 0; i < excelTrafficDayLargeData.length; i++) {
                    const data = excelTrafficDayLargeData[i];

                    // データの曜日が動的順序に含まれているか確認
                    if (dynamicOrder.includes(data.day)) {
                        // データの日時を日付マッピングで計算
                        const dataDateTime = parseDayTimeStringWithDate(data.day, data.time);
                        const dayRange = dayDateRanges[data.day];

                        // その曜日の日付範囲内かつ現在時刻までのデータのみ処理
                        if (dataDateTime >= dayRange.start && dataDateTime <= dayRange.end && dataDateTime <= now) {
                            // 曜日でカウント
                            dayCounts[data.day]++;
                            totalCounts.trafficDayLarge++;

                            // 処理済みデータとしてマーク
                            processedTrafficDayLargeData.push({
                                ...data,
                                fullDateTime: dataDateTime // 実際の日時情報を保存
                            });
                        } else if (dataDateTime > dayRange.end) {
                            // 未来のデータは次の処理対象としてインデックスを保存
                            nextTrafficDayLargeDataIndex = i;
                            break;
                        }
                    }
                }

                // 結果を返す（動的順序で並べ替え）
                const labels = dynamicOrder;
                const dataValues = labels.map(day => dayCounts[day]);

                resolve({
                    labels: labels,
                    data: dataValues
                });
            });
        }

        // Excelデータを処理して曜日別平均速度データを生成（大型車用）
        function processExcelAverageSpeedDayLargeData() {
            return new Promise((resolve) => {
                const now = new Date();
                const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 月曜日=0
                // 現在の曜日より前の曜日のみ処理（例: 木曜日なら月〜水まで）
                const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;

                const dayAverageSpeeds = {
                    '月曜日': null,
                    '火曜日': null,
                    '水曜日': null,
                    '木曜日': null,
                    '金曜日': null,
                    '土曜日': null,
                    '日曜日': null
                };
                processedAverageSpeedDayLargeData = [];

                // 現在の曜日より前のデータのみ処理（月曜日起点）
                for (let i = 0; i < excelAverageSpeedDayLargeData.length; i++) {
                    const data = excelAverageSpeedDayLargeData[i];

                    // データの曜日インデックスを取得
                    const dataDayIndex = dayToNumber(data.day);

                    // 月曜日〜現在の曜日の前日までのデータのみ処理
                    // 例: 木曜日なら月曜日(0)〜水曜日(2)まで
                    if (dataDayIndex <= previousDayIndex) {
                        // 曜日で平均速度を設定
                        if (dayAverageSpeeds.hasOwnProperty(data.day)) {
                            dayAverageSpeeds[data.day] = data.averageSpeed;
                        }

                        // 処理済みデータとしてマーク
                        processedAverageSpeedDayLargeData.push(data);
                    } else {
                        // 現在の曜日以降のデータは次の処理対象としてインデックスを保存
                        nextAverageSpeedDayLargeDataIndex = i;
                        break;
                    }
                }

                // 最新の曜日の値を保存（情報表示用）
                if (previousDayIndex >= 0 && dayAverageSpeeds[dayOrder[previousDayIndex]] !== null) {
                    totalCounts.averageSpeedDayLarge = dayAverageSpeeds[dayOrder[previousDayIndex]];
                }

                // 結果を返す（曜日順に並べ替え）
                const labels = dayOrder;
                const dataValues = labels.map(day => dayAverageSpeeds[day]);

                resolve({
                    labels: labels,
                    data: dataValues
                });
            });
        }

        // 次のデータを処理してグラフを更新（小型車通過台数用）
        function processNextData() {
            const now = new Date();
            const hourlyCounts = Array(24).fill(0); // 0時起点の配列（一時的な保存用）

            // 既存の処理済みデータからカウントを再計算（0時起点）
            for (const data of processedData) {
                const hourMatch = data.timeRange.match(/(\d+)時/);
                if (hourMatch && hourMatch[1]) {
                    const originalHour = parseInt(hourMatch[1]);
                    if (originalHour >= 0 && originalHour < 24) {
                        // 0時起点で一時的にカウント
                        hourlyCounts[originalHour]++;
                    }
                }
            }

            // 次のデータが現在時刻を過ぎているかチェック
            let updated = false;
            while (nextDataIndex < excelRawData.length) {
                const nextData = excelRawData[nextDataIndex];

                // 現在時刻より前のデータを処理
                if (nextData.fullDateTime <= now) {
                    const hourMatch = nextData.timeRange.match(/(\d+)時/);
                    if (hourMatch && hourMatch[1]) {
                        const originalHour = parseInt(hourMatch[1]);
                        if (originalHour >= 0 && originalHour < 24) {
                            // 0時起点で一時的にカウント
                            hourlyCounts[originalHour]++;
                            totalCounts.smallMain++;
                        }
                    }

                    // 処理済みデータに追加
                    processedData.push(nextData);
                    nextDataIndex++;
                    updated = true;
                } else {
                    // 未来のデータは処理しない
                    break;
                }
            }

            if (updated) {
                // ★★★ データを21時起点に再配置 ★★★
                const shiftedHourlyCounts = shiftDataTo21Start(hourlyCounts);

                // 最新データを保存
                chartLatestData.smallInflowsCountByHour = {
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: shiftedHourlyCounts // 21時起点のデータ
                };

                return {
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: shiftedHourlyCounts // 21時起点のデータ
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（大型車通過台数用）
        function processNextDataLarge() {
            const now = new Date();
            const hourlyCounts = Array(24).fill(0); // 0時起点の配列（一時的な保存用）

            // 既存の処理済みデータからカウントを再計算（0時起点）
            for (const data of processedDataLarge) {
                const hourMatch = data.timeRange.match(/(\d+)時/);
                if (hourMatch && hourMatch[1]) {
                    const originalHour = parseInt(hourMatch[1]);
                    if (originalHour >= 0 && originalHour < 24) {
                        // 0時起点で一時的にカウント
                        hourlyCounts[originalHour]++;
                    }
                }
            }

            // 次のデータが現在時刻を過ぎているかチェック
            let updated = false;
            while (nextDataIndexLarge < excelRawDataLarge.length) {
                const nextData = excelRawDataLarge[nextDataIndexLarge];

                // 現在時刻より前のデータを処理
                if (nextData.fullDateTime <= now) {
                    const hourMatch = nextData.timeRange.match(/(\d+)時/);
                    if (hourMatch && hourMatch[1]) {
                        const originalHour = parseInt(hourMatch[1]);
                        if (originalHour >= 0 && originalHour < 24) {
                            // 0時起点で一時的にカウント
                            hourlyCounts[originalHour]++;
                            totalCounts.largeMain++;
                        }
                    }

                    // 処理済みデータに追加
                    processedDataLarge.push(nextData);
                    nextDataIndexLarge++;
                    updated = true;
                } else {
                    // 未来のデータは処理しない
                    break;
                }
            }

            if (updated) {
                // ★★★ データを21時起点に再配置 ★★★
                const shiftedHourlyCounts = shiftDataTo21Start(hourlyCounts);

                // 最新データを保存
                chartLatestData.largeInflowsCountByHour = {
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: shiftedHourlyCounts // 21時起点のデータ
                };

                return {
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: shiftedHourlyCounts // 21時起点のデータ
                };
            }

            return null;
        }

        // 滞在時間データの集計時刻を更新する関数を追加
        function updateStayTimeAggregationTime(chartId) {
            const timeElement = document.getElementById(chartId);
            if (timeElement) {
                timeElement.textContent = `集計時刻: ${getCurrentTimeString().split(' ')[1]}`;
            }
        }

        // 滞在時間データを処理してグラフを更新（小型車滞在時間用）
        function processNextStayTimeData() {
            const now = new Date();
            const currentHour = now.getHours();
            // ★★★ 21時起点で現在時刻の1つ前の時間帯を計算 ★★★
            const shiftedCurrentHour = getShiftedHourIndex(currentHour);
            const previousShiftedHour = shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1;

            const processedData = Array(24).fill(null);

            // 元データを21時起点に再配置
            for (let originalHour = 0; originalHour < 24; originalHour++) {
                const shiftedIndex = getShiftedHourIndex(originalHour);
                if (originalHour < excelStayTimeData.data.length) {
                    // ★★★ 21時起点の位置にデータを配置 ★★★
                    processedData[shiftedIndex] = excelStayTimeData.data[originalHour];
                }
            }

            // 現在時刻より後のデータはnullにする
            for (let i = previousShiftedHour + 1; i < 24; i++) {
                processedData[i] = null;
            }

            // 前回のデータと比較して変更があるかチェック
            let updated = false;
            if (chartLatestData.smallStayTimeByHour.data.length === 0) {
                updated = true;
            } else {
                for (let i = 0; i <= previousShiftedHour; i++) {
                    if (processedData[i] !== chartLatestData.smallStayTimeByHour.data[i]) {
                        updated = true;
                        break;
                    }
                }
            }

            if (updated) {
                // 最新データを保存
                chartLatestData.smallStayTimeByHour = {
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: processedData
                };

                return {
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: processedData
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（大型車滞在時間用）
        function processNextLargeStayTimeData() {
            const now = new Date();
            const currentHour = now.getHours();
            // ★★★ 21時起点で現在時刻の1つ前の時間帯を計算 ★★★
            const shiftedCurrentHour = getShiftedHourIndex(currentHour);
            const previousShiftedHour = shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1;

            const processedData = Array(24).fill(null);

            // 元データを21時起点に再配置
            for (let originalHour = 0; originalHour < 24; originalHour++) {
                const shiftedIndex = getShiftedHourIndex(originalHour);
                if (originalHour < excelLargeStayTimeData.data.length) {
                    // ★★★ 21時起点の位置にデータを配置 ★★★
                    processedData[shiftedIndex] = excelLargeStayTimeData.data[originalHour];
                }
            }

            // 現在時刻より後のデータはnullにする
            for (let i = previousShiftedHour + 1; i < 24; i++) {
                processedData[i] = null;
            }

            // 前回のデータと比較して変更があるかチェック
            let updated = false;
            if (chartLatestData.largeStayTimeByHour.data.length === 0) {
                updated = true;
            } else {
                for (let i = 0; i <= previousShiftedHour; i++) {
                    if (processedData[i] !== chartLatestData.largeStayTimeByHour.data[i]) {
                        updated = true;
                        break;
                    }
                }
            }

            if (updated) {
                // 最新データを保存
                chartLatestData.largeStayTimeByHour = {
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: processedData
                };

                return {
                    labels: generateTimeRangeLabels21Start(), // 21時起点のラベル
                    data: processedData
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（曜日別小型車通過台数用）- 日付マッピング対応
        function processNextDayData() {
            const now = new Date();
            const dynamicOrder = generateDynamicDayOrder();
            const dayDateMap = generateDayDateMapping();

            // 動的順序に基づいてカウント用オブジェクトを初期化
            const dayCounts = {};
            dynamicOrder.forEach(day => {
                dayCounts[day] = 0;
            });

            // 各曜日の日付範囲を設定
            const dayDateRanges = {};
            dynamicOrder.forEach(day => {
                const dayStart = new Date(dayDateMap[day]);
                dayStart.setHours(0, 0, 0, 0);

                const dayEnd = new Date(dayDateMap[day]);
                dayEnd.setHours(23, 59, 59, 999);

                dayDateRanges[day] = {
                    start: dayStart,
                    end: dayEnd
                };
            });

            // 既存の処理済みデータからカウントを再計算
            for (const data of processedDayData) {
                if (dynamicOrder.includes(data.day)) {
                    dayCounts[data.day]++;
                }
            }

            // 次のデータが現在時刻の範囲内かチェック
            let updated = false;
            while (nextDayDataIndex < excelDayData.length) {
                const nextData = excelDayData[nextDayDataIndex];

                // データの曜日が動的順序に含まれているか確認
                if (dynamicOrder.includes(nextData.day)) {
                    // データの日時を日付マッピングで計算
                    const dataDateTime = parseDayTimeStringWithDate(nextData.day, nextData.time);
                    const dayRange = dayDateRanges[nextData.day];

                    // その曜日の日付範囲内かつ現在時刻までのデータを処理
                    if (dataDateTime >= dayRange.start && dataDateTime <= dayRange.end && dataDateTime <= now) {
                        dayCounts[nextData.day]++;
                        totalCounts.smallDay++;

                        // 処理済みデータに追加
                        processedDayData.push({
                            ...nextData,
                            fullDateTime: dataDateTime
                        });
                        nextDayDataIndex++;
                        updated = true;
                    } else if (dataDateTime > dayRange.end || dataDateTime > now) {
                        // 未来のデータは処理しない
                        break;
                    } else {
                        // 日付範囲外のデータはスキップ
                        nextDayDataIndex++;
                    }
                } else {
                    // 動的順序に含まれない曜日のデータはスキップ
                    nextDayDataIndex++;
                }
            }

            if (updated) {
                // 最新データを保存
                const labels = dynamicOrder;
                const dataValues = labels.map(day => dayCounts[day]);

                chartLatestData.smallInflowsCounByDay = {
                    labels: labels,
                    data: dataValues
                };

                return {
                    labels: labels,
                    data: dataValues
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（曜日別大型車通過台数用）- 日付マッピング対応
        function processNextDayDataLarge() {
            const now = new Date();
            const dynamicOrder = generateDynamicDayOrder();
            const dayDateMap = generateDayDateMapping();

            // 動的順序に基づいてカウント用オブジェクトを初期化
            const dayCounts = {};
            dynamicOrder.forEach(day => {
                dayCounts[day] = 0;
            });

            // 各曜日の日付範囲を設定
            const dayDateRanges = {};
            dynamicOrder.forEach(day => {
                const dayStart = new Date(dayDateMap[day]);
                dayStart.setHours(0, 0, 0, 0);

                const dayEnd = new Date(dayDateMap[day]);
                dayEnd.setHours(23, 59, 59, 999);

                dayDateRanges[day] = {
                    start: dayStart,
                    end: dayEnd
                };
            });

            // 既存の処理済みデータからカウントを再計算
            for (const data of processedDayDataLarge) {
                if (dynamicOrder.includes(data.day)) {
                    dayCounts[data.day]++;
                }
            }

            // 次のデータが現在時刻の範囲内かチェック
            let updated = false;
            while (nextDayDataIndexLarge < excelDayDataLarge.length) {
                const nextData = excelDayDataLarge[nextDayDataIndexLarge];

                // データの曜日が動的順序に含まれているか確認
                if (dynamicOrder.includes(nextData.day)) {
                    // データの日時を日付マッピングで計算
                    const dataDateTime = parseDayTimeStringWithDate(nextData.day, nextData.time);
                    const dayRange = dayDateRanges[nextData.day];

                    // その曜日の日付範囲内かつ現在時刻までのデータを処理
                    if (dataDateTime >= dayRange.start && dataDateTime <= dayRange.end && dataDateTime <= now) {
                        dayCounts[nextData.day]++;
                        totalCounts.largeDay++;

                        // 処理済みデータに追加
                        processedDayDataLarge.push({
                            ...nextData,
                            fullDateTime: dataDateTime
                        });
                        nextDayDataIndexLarge++;
                        updated = true;
                    } else if (dataDateTime > dayRange.end || dataDateTime > now) {
                        // 未来のデータは処理しない
                        break;
                    } else {
                        // 日付範囲外のデータはスキップ
                        nextDayDataIndexLarge++;
                    }
                } else {
                    // 動的順序に含まれない曜日のデータはスキップ
                    nextDayDataIndexLarge++;
                }
            }

            if (updated) {
                // 最新データを保存
                const labels = dynamicOrder;
                const dataValues = labels.map(day => dayCounts[day]);

                chartLatestData.largeInflowsCountByDay = {
                    labels: labels,
                    data: dataValues
                };

                return {
                    labels: labels,
                    data: dataValues
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（曜日別小型車滞在時間用）
        function processNextDayStayTimeData() {
            const now = new Date();
            const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 月曜日=0
            // 現在の曜日より前の曜日のみ処理（例: 木曜日なら月〜水まで）
            const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;

            const dayStayTimes = {
                '月曜日': null,
                '火曜日': null,
                '水曜日': null,
                '木曜日': null,
                '金曜日': null,
                '土曜日': null,
                '日曜日': null
            };

            // 既存の処理済みデータから滞在時間を再計算
            for (const data of processedDayStayTimeData) {
                if (dayStayTimes.hasOwnProperty(data.day)) {
                    dayStayTimes[data.day] = data.stayTime;
                }
            }

            // 次のデータが月曜日〜現在の曜日の前日の範囲内かチェック
            let updated = false;
            while (nextDayStayTimeDataIndex < excelDayStayTimeData.length) {
                const nextData = excelDayStayTimeData[nextDayStayTimeDataIndex];

                // データの曜日インデックスを取得
                const dataDayIndex = dayToNumber(nextData.day);

                // 月曜日〜現在の曜日の前日までのデータのみ処理
                if (dataDayIndex <= previousDayIndex) {
                    if (dayStayTimes.hasOwnProperty(nextData.day)) {
                        dayStayTimes[nextData.day] = nextData.stayTime;
                    }

                    // 処理済みデータに追加
                    processedDayStayTimeData.push(nextData);
                    nextDayStayTimeDataIndex++;
                    updated = true;
                } else {
                    // 現在の曜日以降のデータは処理しない
                    break;
                }
            }

            if (updated) {
                // 最新データを保存
                const labels = dayOrder;
                const dataValues = labels.map(day => dayStayTimes[day]);

                chartLatestData.smallStayTimeByDay = {
                    labels: labels,
                    data: dataValues
                };

                return {
                    labels: labels,
                    data: dataValues
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（曜日別大型車滞在時間用）
        function processNextDayStayTimeDataLarge() {
            const now = new Date();
            const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 月曜日=0
            // 現在の曜日より前の曜日のみ処理（例: 木曜日なら月〜水まで）
            const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;

            const dayStayTimes = {
                '月曜日': null,
                '火曜日': null,
                '水曜日': null,
                '木曜日': null,
                '金曜日': null,
                '土曜日': null,
                '日曜日': null
            };

            // 既存の処理済みデータから滞在時間を再計算
            for (const data of processedDayStayTimeDataLarge) {
                if (dayStayTimes.hasOwnProperty(data.day)) {
                    dayStayTimes[data.day] = data.stayTime;
                }
            }

            // 次のデータが月曜日〜現在の曜日の前日の範囲内かチェック
            let updated = false;
            while (nextDayStayTimeDataIndexLarge < excelDayStayTimeDataLarge.length) {
                const nextData = excelDayStayTimeDataLarge[nextDayStayTimeDataIndexLarge];

                // データの曜日インデックスを取得
                const dataDayIndex = dayToNumber(nextData.day);

                // 月曜日〜現在の曜日の前日までのデータのみ処理
                if (dataDayIndex <= previousDayIndex) {
                    if (dayStayTimes.hasOwnProperty(nextData.day)) {
                        dayStayTimes[nextData.day] = nextData.stayTime;
                    }

                    // 処理済みデータに追加
                    processedDayStayTimeDataLarge.push(nextData);
                    nextDayStayTimeDataIndexLarge++;
                    updated = true;
                } else {
                    // 現在の曜日以降のデータは処理しない
                    break;
                }
            }

            if (updated) {
                // 最新データを保存
                const labels = dayOrder;
                const dataValues = labels.map(day => dayStayTimes[day]);

                chartLatestData.largeStayTimeByDay = {
                    labels: labels,
                    data: dataValues
                };

                return {
                    labels: labels,
                    data: dataValues
                };
            }

            return null;
        }

        // 道路交通観測次のデータ処理
        // 次のデータを処理してグラフを更新（小型車通過台数用）
        function processNextTrafficSmallData() {
            const now = new Date();
            const hourlyCounts = Array(24).fill(0);

            // 既存の処理済みデータからカウントを再計算
            for (const data of processedTrafficSmallData) {
                const hour = data.fullDateTime.getHours();
                if (hour >= 0 && hour < 24) {
                    hourlyCounts[hour]++;
                }
            }

            // 次のデータが現在時刻を過ぎているかチェック
            let updated = false;
            while (nextTrafficSmallDataIndex < excelTrafficSmallData.length) {
                const nextData = excelTrafficSmallData[nextTrafficSmallDataIndex];

                // 現在時刻より前のデータを処理
                if (nextData.fullDateTime <= now) {
                    const hour = nextData.fullDateTime.getHours();
                    if (hour >= 0 && hour < 24) {
                        hourlyCounts[hour]++;
                        totalCounts.trafficSmall++;
                    }

                    // 処理済みデータに追加
                    processedTrafficSmallData.push(nextData);
                    nextTrafficSmallDataIndex++;
                    updated = true;
                } else {
                    // 未来のデータは処理しない
                    break;
                }
            }

            if (updated) {
                // 最新データを保存
                chartLatestData.smallTrafficCountByHour = {
                    labels: generateTimeRangeLabels(),
                    data: hourlyCounts
                };

                return {
                    labels: generateTimeRangeLabels(),
                    data: hourlyCounts
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（小型車平均速度用）
        function processNextAverageSpeedSmallData() {
            const now = new Date();
            const currentHour = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            // 毎時00分00秒になったら次の時間帯のデータを表示
            if (minutes === 0 && seconds === 0) {
                const displayHour = currentHour === 0 ? 23 : currentHour - 1;
                const nextHour = currentHour;

                // 次の時間帯のデータが存在するか確認
                if (nextAverageSpeedSmallDataIndex < excelAverageSpeedSmallData.length &&
                    nextAverageSpeedSmallDataIndex === nextHour) {

                    const nextData = excelAverageSpeedSmallData[nextAverageSpeedSmallDataIndex];
                    if (nextData) {
                        // 処理済みデータに追加
                        processedAverageSpeedSmallData.push(nextData);

                        // 最新データを更新
                        const updatedData = [...chartLatestData.smallAverageSpeedByHour.data];
                        updatedData[nextHour] = nextData.averageSpeed;

                        // 最新の時間帯の値を保存（情報表示用）
                        totalCounts.averageSpeedSmall = nextData.averageSpeed;

                        chartLatestData.smallAverageSpeedByHour = {
                            labels: generateTimeRangeLabels(),
                            data: updatedData
                        };

                        nextAverageSpeedSmallDataIndex++;

                        return {
                            labels: generateTimeRangeLabels(),
                            data: updatedData
                        };
                    }
                }
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（大型車通過台数用）
        function processNextTrafficLargeData() {
            const now = new Date();
            const hourlyCounts = Array(24).fill(0);

            // 既存の処理済みデータからカウントを再計算
            for (const data of processedTrafficLargeData) {
                const hour = data.fullDateTime.getHours();
                if (hour >= 0 && hour < 24) {
                    hourlyCounts[hour]++;
                }
            }

            // 次のデータが現在時刻を過ぎているかチェック
            let updated = false;
            while (nextTrafficLargeDataIndex < excelTrafficLargeData.length) {
                const nextData = excelTrafficLargeData[nextTrafficLargeDataIndex];

                // 現在時刻より前のデータを処理
                if (nextData.fullDateTime <= now) {
                    const hour = nextData.fullDateTime.getHours();
                    if (hour >= 0 && hour < 24) {
                        hourlyCounts[hour]++;
                        totalCounts.trafficLarge++;
                    }

                    // 処理済みデータに追加
                    processedTrafficLargeData.push(nextData);
                    nextTrafficLargeDataIndex++;
                    updated = true;
                } else {
                    // 未来のデータは処理しない
                    break;
                }
            }

            if (updated) {
                // 最新データを保存
                chartLatestData.largeTrafficCountByHour = {
                    labels: generateTimeRangeLabels(),
                    data: hourlyCounts
                };

                return {
                    labels: generateTimeRangeLabels(),
                    data: hourlyCounts
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（大型車平均速度用）
        function processNextAverageSpeedLargeData() {
            const now = new Date();
            const currentHour = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            // 毎時00分00秒になったら次の時間帯のデータを表示
            if (minutes === 0 && seconds === 0) {
                const displayHour = currentHour === 0 ? 23 : currentHour - 1;
                const nextHour = currentHour;

                // 次の時間帯のデータが存在するか確認
                if (nextAverageSpeedLargeDataIndex < excelAverageSpeedLargeData.length &&
                    nextAverageSpeedLargeDataIndex === nextHour) {

                    const nextData = excelAverageSpeedLargeData[nextAverageSpeedLargeDataIndex];
                    if (nextData) {
                        // 処理済みデータに追加
                        processedAverageSpeedLargeData.push(nextData);

                        // 最新データを更新
                        const updatedData = [...chartLatestData.largeAverageSpeedByHour.data];
                        updatedData[nextHour] = nextData.averageSpeed;

                        // 最新の時間帯の値を保存（情報表示用）
                        totalCounts.averageSpeedLarge = nextData.averageSpeed;

                        chartLatestData.largeAverageSpeedByHour = {
                            labels: generateTimeRangeLabels(),
                            data: updatedData
                        };

                        nextAverageSpeedLargeDataIndex++;

                        return {
                            labels: generateTimeRangeLabels(),
                            data: updatedData
                        };
                    }
                }
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（曜日別小型車通過台数用）- 道路交通観測、日付マッピング対応
        function processNextTrafficDaySmallData() {
            const now = new Date();
            const dynamicOrder = generateDynamicDayOrder();
            const dayDateMap = generateDayDateMapping();

            // 動的順序に基づいてカウント用オブジェクトを初期化
            const dayCounts = {};
            dynamicOrder.forEach(day => {
                dayCounts[day] = 0;
            });

            // 各曜日の日付範囲を設定
            const dayDateRanges = {};
            dynamicOrder.forEach(day => {
                const dayStart = new Date(dayDateMap[day]);
                dayStart.setHours(0, 0, 0, 0);

                const dayEnd = new Date(dayDateMap[day]);
                dayEnd.setHours(23, 59, 59, 999);

                dayDateRanges[day] = {
                    start: dayStart,
                    end: dayEnd
                };
            });

            // 既存の処理済みデータからカウントを再計算
            for (const data of processedTrafficDaySmallData) {
                if (dynamicOrder.includes(data.day)) {
                    dayCounts[data.day]++;
                }
            }

            // 次のデータが現在時刻の範囲内かチェック
            let updated = false;
            while (nextTrafficDaySmallDataIndex < excelTrafficDaySmallData.length) {
                const nextData = excelTrafficDaySmallData[nextTrafficDaySmallDataIndex];

                // データの曜日が動的順序に含まれているか確認
                if (dynamicOrder.includes(nextData.day)) {
                    // データの日時を日付マッピングで計算
                    const dataDateTime = parseDayTimeStringWithDate(nextData.day, nextData.time);
                    const dayRange = dayDateRanges[nextData.day];

                    // その曜日の日付範囲内かつ現在時刻までのデータを処理
                    if (dataDateTime >= dayRange.start && dataDateTime <= dayRange.end && dataDateTime <= now) {
                        dayCounts[nextData.day]++;
                        totalCounts.trafficDaySmall++;

                        // 処理済みデータに追加
                        processedTrafficDaySmallData.push({
                            ...nextData,
                            fullDateTime: dataDateTime
                        });
                        nextTrafficDaySmallDataIndex++;
                        updated = true;
                    } else if (dataDateTime > dayRange.end || dataDateTime > now) {
                        // 未来のデータは処理しない
                        break;
                    } else {
                        // 日付範囲外のデータはスキップ
                        nextTrafficDaySmallDataIndex++;
                    }
                } else {
                    // 動的順序に含まれない曜日のデータはスキップ
                    nextTrafficDaySmallDataIndex++;
                }
            }

            if (updated) {
                // 最新データを保存
                const labels = dynamicOrder;
                const dataValues = labels.map(day => dayCounts[day]);

                chartLatestData.smallTrafficCountByDay = {
                    labels: labels,
                    data: dataValues
                };

                return {
                    labels: labels,
                    data: dataValues
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（曜日別小型車平均速度用）
        function processNextAverageSpeedDaySmallData() {
            const now = new Date();
            const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 月曜日=0
            // 現在の曜日より前の曜日のみ処理（例: 木曜日なら月〜水まで）
            const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;

            const dayAverageSpeeds = {
                '月曜日': null,
                '火曜日': null,
                '水曜日': null,
                '木曜日': null,
                '金曜日': null,
                '土曜日': null,
                '日曜日': null
            };

            // 既存の処理済みデータから平均速度を再計算
            for (const data of processedAverageSpeedDaySmallData) {
                if (dayAverageSpeeds.hasOwnProperty(data.day)) {
                    dayAverageSpeeds[data.day] = data.averageSpeed;
                }
            }

            // 次のデータが月曜日〜現在の曜日の前日の範囲内かチェック
            let updated = false;
            while (nextAverageSpeedDaySmallDataIndex < excelAverageSpeedDaySmallData.length) {
                const nextData = excelAverageSpeedDaySmallData[nextAverageSpeedDaySmallDataIndex];

                // データの曜日インデックスを取得
                const dataDayIndex = dayToNumber(nextData.day);

                // 月曜日〜現在の曜日の前日までのデータのみ処理
                if (dataDayIndex <= previousDayIndex) {
                    if (dayAverageSpeeds.hasOwnProperty(nextData.day)) {
                        dayAverageSpeeds[nextData.day] = nextData.averageSpeed;
                    }

                    // 処理済みデータに追加
                    processedAverageSpeedDaySmallData.push(nextData);
                    nextAverageSpeedDaySmallDataIndex++;
                    updated = true;
                } else {
                    // 現在の曜日以降のデータは処理しない
                    break;
                }
            }

            if (updated) {
                // 最新の曜日の値を保存（情報表示用）
                if (previousDayIndex >= 0 && dayAverageSpeeds[dayOrder[previousDayIndex]] !== null) {
                    totalCounts.averageSpeedDaySmall = dayAverageSpeeds[dayOrder[previousDayIndex]];
                }

                // 最新データを保存
                const labels = dayOrder;
                const dataValues = labels.map(day => dayAverageSpeeds[day]);

                chartLatestData.smallAverageSpeedByDay = {
                    labels: labels,
                    data: dataValues
                };

                return {
                    labels: labels,
                    data: dataValues
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（曜日別大型車通過台数用）- 道路交通観測、日付マッピング対応
        function processNextTrafficDayLargeData() {
            const now = new Date();
            const dynamicOrder = generateDynamicDayOrder();
            const dayDateMap = generateDayDateMapping();

            // 動的順序に基づいてカウント用オブジェクトを初期化
            const dayCounts = {};
            dynamicOrder.forEach(day => {
                dayCounts[day] = 0;
            });

            // 各曜日の日付範囲を設定
            const dayDateRanges = {};
            dynamicOrder.forEach(day => {
                const dayStart = new Date(dayDateMap[day]);
                dayStart.setHours(0, 0, 0, 0);

                const dayEnd = new Date(dayDateMap[day]);
                dayEnd.setHours(23, 59, 59, 999);

                dayDateRanges[day] = {
                    start: dayStart,
                    end: dayEnd
                };
            });

            // 既存の処理済みデータからカウントを再計算
            for (const data of processedTrafficDayLargeData) {
                if (dynamicOrder.includes(data.day)) {
                    dayCounts[data.day]++;
                }
            }

            // 次のデータが現在時刻の範囲内かチェック
            let updated = false;
            while (nextTrafficDayLargeDataIndex < excelTrafficDayLargeData.length) {
                const nextData = excelTrafficDayLargeData[nextTrafficDayLargeDataIndex];

                // データの曜日が動的順序に含まれているか確認
                if (dynamicOrder.includes(nextData.day)) {
                    // データの日時を日付マッピングで計算
                    const dataDateTime = parseDayTimeStringWithDate(nextData.day, nextData.time);
                    const dayRange = dayDateRanges[nextData.day];

                    // その曜日の日付範囲内かつ現在時刻までのデータを処理
                    if (dataDateTime >= dayRange.start && dataDateTime <= dayRange.end && dataDateTime <= now) {
                        dayCounts[nextData.day]++;
                        totalCounts.trafficDayLarge++;

                        // 処理済みデータに追加
                        processedTrafficDayLargeData.push({
                            ...nextData,
                            fullDateTime: dataDateTime
                        });
                        nextTrafficDayLargeDataIndex++;
                        updated = true;
                    } else if (dataDateTime > dayRange.end || dataDateTime > now) {
                        // 未来のデータは処理しない
                        break;
                    } else {
                        // 日付範囲外のデータはスキップ
                        nextTrafficDayLargeDataIndex++;
                    }
                } else {
                    // 動的順序に含まれない曜日のデータはスキップ
                    nextTrafficDayLargeDataIndex++;
                }
            }

            if (updated) {
                // 最新データを保存
                const labels = dynamicOrder;
                const dataValues = labels.map(day => dayCounts[day]);

                chartLatestData.largeTrafficCountByDay = {
                    labels: labels,
                    data: dataValues
                };

                return {
                    labels: labels,
                    data: dataValues
                };
            }

            return null;
        }

        // 次のデータを処理してグラフを更新（曜日別大型車平均速度用）
        function processNextAverageSpeedDayLargeData() {
            const now = new Date();
            const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 月曜日=0
            // 現在の曜日より前の曜日のみ処理（例: 木曜日なら月〜水まで）
            const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;

            const dayAverageSpeeds = {
                '月曜日': null,
                '火曜日': null,
                '水曜日': null,
                '木曜日': null,
                '金曜日': null,
                '土曜日': null,
                '日曜日': null
            };

            // 既存の処理済みデータから平均速度を再計算
            for (const data of processedAverageSpeedDayLargeData) {
                if (dayAverageSpeeds.hasOwnProperty(data.day)) {
                    dayAverageSpeeds[data.day] = data.averageSpeed;
                }
            }

            // 次のデータが月曜日〜現在の曜日の前日の範囲内かチェック
            let updated = false;
            while (nextAverageSpeedDayLargeDataIndex < excelAverageSpeedDayLargeData.length) {
                const nextData = excelAverageSpeedDayLargeData[nextAverageSpeedDayLargeDataIndex];

                // データの曜日インデックスを取得
                const dataDayIndex = dayToNumber(nextData.day);

                // 月曜日〜現在の曜日の前日までのデータのみ処理
                if (dataDayIndex <= previousDayIndex) {
                    if (dayAverageSpeeds.hasOwnProperty(nextData.day)) {
                        dayAverageSpeeds[nextData.day] = nextData.averageSpeed;
                    }

                    // 処理済みデータに追加
                    processedAverageSpeedDayLargeData.push(nextData);
                    nextAverageSpeedDayLargeDataIndex++;
                    updated = true;
                } else {
                    // 現在の曜日以降のデータは処理しない
                    break;
                }
            }

            if (updated) {
                // 最新の曜日の値を保存（情報表示用）
                if (previousDayIndex >= 0 && dayAverageSpeeds[dayOrder[previousDayIndex]] !== null) {
                    totalCounts.averageSpeedDayLarge = dayAverageSpeeds[dayOrder[previousDayIndex]];
                }

                // 最新データを保存
                const labels = dayOrder;
                const dataValues = labels.map(day => dayAverageSpeeds[day]);

                chartLatestData.largeAverageSpeedByDay = {
                    labels: labels,
                    data: dataValues
                };

                return {
                    labels: labels,
                    data: dataValues
                };
            }

            return null;
        }

        // デバッグ用：日付マッピングをコンソール表示
        function debugDayDateMapping() {
            const dayDateMap = generateDayDateMapping();
            const dynamicOrder = generateDynamicDayOrder();

            console.log('動的曜日順序と日付マッピング:');
            dynamicOrder.forEach((day, index) => {
                const date = dayDateMap[day];
                console.log(`${index}: ${day} - ${date.toLocaleDateString()}`);
            });
        }

        // 時間帯ラベルを生成
        function generateTimeRangeLabels() {
            const labels = [];
            for (let i = 0; i < 24; i++) {
                labels.push(`${i}時`);
            }
            return labels;
        }

        // 時間帯ラベルを生成（21時から開始）
        function generateTimeRangeLabels21Start() {
            const labels = [];
            for (let i = 0; i < 24; i++) {
                // 21時から開始して順番に表示
                const displayHour = getDisplayHour(i);
                labels.push(`${displayHour}時`);
            }
            return labels;
        }

        // 各グラフの情報更新処理
        function updateChartInfo() {
            const now = new Date();
            const currentHour = now.getHours();
            // ★★★ 21時起点の表示時間に変換 ★★★
            const shiftedCurrentHour = getShiftedHourIndex(currentHour);
            const previousDisplayHour = getDisplayHour(shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1); // 21時スタートのグラフの表示する時間帯（1つ前）
            const displayHour = currentHour === 0 ? 23 : currentHour - 1; // 表示する時間帯（1つ前）
            const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // 日曜日調整
            const currentDay = dayOrder[currentDayIndex];
            // 表示する曜日は現在曜日の1つ前（例: 木曜日なら水曜日を表示）
            const displayDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;
            const displayDay = dayOrder[displayDayIndex];

            // 小型車通過台数グラフの情報を更新
            if (document.getElementById('small-main-info')) {
                const totalElement = document.getElementById('small-main-total');
                const hourlyElement = document.getElementById('small-main-hourly');

                if (totalElement && hourlyElement && chartLatestData.smallInflowsCountByHour.data.length > 0) {
                    totalElement.textContent = `${totalCounts.smallMain}台/日`;
                    // ★★★ 21時起点で現在時間帯のデータを表示 ★★★
                    hourlyElement.textContent = `${chartLatestData.smallInflowsCountByHour.data[shiftedCurrentHour] || 0}台`;
                }
            }

            // 大型車通過台数グラフの情報を更新
            if (document.getElementById('large-main-info')) {
                const totalElement = document.getElementById('large-main-total');
                const hourlyElement = document.getElementById('large-main-hourly');

                if (totalElement && hourlyElement && chartLatestData.largeInflowsCountByHour.data.length > 0) {
                    totalElement.textContent = `${totalCounts.largeMain}台/日`;
                    // ★★★ 21時起点で現在時間帯のデータを表示 ★★★
                    hourlyElement.textContent = `${chartLatestData.largeInflowsCountByHour.data[shiftedCurrentHour] || 0}台`;
                }
            }

            // 小型車滞在時間グラフの情報を更新（1つ前の時間帯を表示）
            if (document.getElementById('small-sub-info')) {
                const stayTimeElement = document.getElementById('small-sub-staytime');

                if (stayTimeElement && chartLatestData.smallStayTimeByHour.data.length > 0) {
                    const displayStayTime = chartLatestData.smallStayTimeByHour.data[shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1];
                    if (displayStayTime !== null) {
                        // ★★★ 21時起点で表示時間を計算 ★★★
                        stayTimeElement.textContent = `${previousDisplayHour}時の滞在時間の中央値:${displayStayTime}分`;
                    } else {
                        stayTimeElement.textContent = `${previousDisplayHour}時のデータはまだありません`;
                    }
                }
            }

            // 大型車滞在時間グラフの情報を更新（1つ前の時間帯を表示）
            if (document.getElementById('large-sub-info')) {
                const stayTimeElement = document.getElementById('large-sub-staytime');

                if (stayTimeElement && chartLatestData.largeStayTimeByHour.data.length > 0) {
                    const displayStayTime = chartLatestData.largeStayTimeByHour.data[shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1];
                    if (displayStayTime !== null) {
                        // ★★★ 21時起点で表示時間を計算 ★★★
                        stayTimeElement.textContent = `${previousDisplayHour}時の滞在時間の中央値:${displayStayTime}分`;
                    } else {
                        stayTimeElement.textContent = `${previousDisplayHour}時のデータはまだありません`;
                    }
                }
            }

            // 曜日別小型車通過台数グラフの情報を更新
            if (document.getElementById('small-day-info')) {
                const totalElement = document.getElementById('small-day-total');
                const dailyElement = document.getElementById('small-day-daily');

                if (totalElement && dailyElement && chartLatestData.smallInflowsCounByDay.data.length > 0) {
                    const dynamicOrder = generateDynamicDayOrder();
                    // 最新の曜日（右端）のデータを表示
                    const latestDayIndex = dynamicOrder.length - 1;

                    totalElement.textContent = `${totalCounts.smallDay}台/週`;
                    dailyElement.textContent = `${chartLatestData.smallInflowsCounByDay.data[latestDayIndex] || 0}台`;
                }
            }

            // 曜日別大型車通過台数グラフの情報を更新
            if (document.getElementById('large-day-info')) {
                const totalElement = document.getElementById('large-day-total');
                const dailyElement = document.getElementById('large-day-daily');

                if (totalElement && dailyElement && chartLatestData.largeInflowsCountByDay.data.length > 0) {
                    totalElement.textContent = `${totalCounts.largeDay}台/週`;
                    dailyElement.textContent = `${chartLatestData.largeInflowsCountByDay.data[currentDayIndex] || 0}台`;
                }
            }

            // 曜日別小型車滞在時間グラフの情報を更新
            if (document.getElementById('small-day-staytime-info')) {
                const stayTimeElement = document.getElementById('small-day-staytime-value');

                if (stayTimeElement && chartLatestData.smallStayTimeByDay.data.length > 0) {
                    // 現在曜日の1つ前の曜日の滞在時間を表示
                    const displayStayTime = chartLatestData.smallStayTimeByDay.data[displayDayIndex];
                    if (displayStayTime !== null) {
                        // 分を時間文字列に変換
                        const hours = Math.floor(displayStayTime / 60);
                        const minutes = Math.round(displayStayTime % 60);
                        const timeString = hours > 0 ?
                            `${hours}時間${minutes}分` :
                            `${minutes}分`;

                        stayTimeElement.textContent = `${displayDay}の滞在時間の中央値:${timeString}`;
                    } else {
                        stayTimeElement.textContent = `${displayDay}のデータはまだありません`;
                    }
                }
            }

            // 曜日別大型車滞在時間グラフの情報を更新
            if (document.getElementById('large-day-staytime-info')) {
                const stayTimeElement = document.getElementById('large-day-staytime-value');

                if (stayTimeElement && chartLatestData.largeStayTimeByDay.data.length > 0) {
                    // 現在曜日の1つ前の曜日の滞在時間を表示
                    const displayStayTime = chartLatestData.largeStayTimeByDay.data[displayDayIndex];
                    if (displayStayTime !== null) {
                        // 分を時間文字列に変換
                        const hours = Math.floor(displayStayTime / 60);
                        const minutes = Math.round(displayStayTime % 60);
                        const timeString = hours > 0 ?
                            `${hours}時間${minutes}分` :
                            `${minutes}分`;

                        stayTimeElement.textContent = `${displayDay}の滞在時間の中央値:${timeString}`;
                    } else {
                        stayTimeElement.textContent = `${displayDay}のデータはまだありません`;
                    }
                }
            }

            // 道路交通観測のグラフ
            // 小型車通過台数グラフの情報を更新
            if (document.getElementById('traffic-small-info')) {
                const totalElement = document.getElementById('traffic-small-total');
                const hourlyElement = document.getElementById('traffic-small-hourly');

                if (totalElement && hourlyElement && chartLatestData.smallTrafficCountByHour.data.length > 0) {
                    const now = new Date();
                    const currentHour = now.getHours();

                    totalElement.textContent = `${totalCounts.trafficSmall}台/日`;
                    hourlyElement.textContent = `${chartLatestData.smallTrafficCountByHour.data[currentHour] || 0}台`;
                }
            }

            // 小型車平均速度グラフの情報を更新
            if (document.getElementById('average-speed-small-info')) {
                const averageSpeedElement = document.getElementById('average-speed-small-value');

                if (averageSpeedElement) {
                    const now = new Date();
                    const currentHour = now.getHours();
                    const displayHour = currentHour === 0 ? 23 : currentHour - 1;

                    if (totalCounts.averageSpeedSmall > 0) {
                        averageSpeedElement.textContent = `${displayHour}時の平均速度の中央値:${totalCounts.averageSpeedSmall}km/h`;
                    } else {
                        averageSpeedElement.textContent = `${displayHour}時のデータはまだありません`;
                    }
                }
            }

            // 大型車通過台数グラフの情報を更新
            if (document.getElementById('traffic-large-info')) {
                const totalElement = document.getElementById('traffic-large-total');
                const hourlyElement = document.getElementById('traffic-large-hourly');

                if (totalElement && hourlyElement && chartLatestData.largeTrafficCountByHour.data.length > 0) {
                    const now = new Date();
                    const currentHour = now.getHours();

                    totalElement.textContent = `${totalCounts.trafficLarge}台/日`;
                    hourlyElement.textContent = `${chartLatestData.largeTrafficCountByHour.data[currentHour] || 0}台`;
                }
            }

            // 大型車平均速度グラフの情報を更新
            if (document.getElementById('average-speed-large-info')) {
                const averageSpeedElement = document.getElementById('average-speed-large-value');

                if (averageSpeedElement) {
                    const now = new Date();
                    const currentHour = now.getHours();
                    const displayHour = currentHour === 0 ? 23 : currentHour - 1;

                    if (totalCounts.averageSpeedLarge > 0) {
                        averageSpeedElement.textContent = `${displayHour}時の平均速度の中央値:${totalCounts.averageSpeedLarge}km/h`;
                    } else {
                        averageSpeedElement.textContent = `${displayHour}時のデータはまだありません`;
                    }
                }
            }

            // 曜日別小型車通過台数グラフの情報を更新（道路交通観測）
            if (document.getElementById('traffic-day-small-info')) {
                const totalElement = document.getElementById('traffic-day-small-total');
                const dailyElement = document.getElementById('traffic-day-small-daily');

                if (totalElement && dailyElement && chartLatestData.smallTrafficCountByDay.data.length > 0) {
                    const dynamicOrder = generateDynamicDayOrder();
                    // 最新の曜日（右端）のデータを表示
                    const latestDayIndex = dynamicOrder.length - 1;

                    totalElement.textContent = `${totalCounts.trafficDaySmall}台/週`;
                    dailyElement.textContent = `${chartLatestData.smallTrafficCountByDay.data[latestDayIndex] || 0}台`;
                }
            }

            // 曜日別小型車平均速度グラフの情報を更新
            if (document.getElementById('average-speed-day-small-info')) {
                const averageSpeedElement = document.getElementById('average-speed-day-small-value');

                if (averageSpeedElement) {
                    const now = new Date();
                    const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1;
                    // 表示する曜日は現在曜日の1つ前（例: 木曜日なら水曜日を表示）
                    const displayDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;
                    const displayDay = dayOrder[displayDayIndex];

                    if (totalCounts.averageSpeedDaySmall > 0) {
                        averageSpeedElement.textContent = `${displayDay}の平均速度の中央値:${totalCounts.averageSpeedDaySmall}km/h`;
                    } else {
                        averageSpeedElement.textContent = `${displayDay}のデータはまだありません`;
                    }
                }
            }

            // 曜日別大型車通過台数グラフの情報を更新（道路交通観測）
            if (document.getElementById('traffic-day-large-info')) {
                const totalElement = document.getElementById('traffic-day-large-total');
                const dailyElement = document.getElementById('traffic-day-large-daily');

                if (totalElement && dailyElement && chartLatestData.largeTrafficCountByDay.data.length > 0) {
                    const dynamicOrder = generateDynamicDayOrder();
                    // 最新の曜日（右端）のデータを表示
                    const latestDayIndex = dynamicOrder.length - 1;

                    totalElement.textContent = `${totalCounts.trafficDayLarge}台/週`;
                    dailyElement.textContent = `${chartLatestData.largeTrafficCountByDay.data[latestDayIndex] || 0}台`;
                }
            }

            // 曜日別大型車平均速度グラフの情報を更新
            if (document.getElementById('average-speed-day-large-info')) {
                const averageSpeedElement = document.getElementById('average-speed-day-large-value');

                if (averageSpeedElement) {
                    const now = new Date();
                    const currentDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1;
                    // 表示する曜日は現在曜日の1つ前（例: 木曜日なら水曜日を表示）
                    const displayDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;
                    const displayDay = dayOrder[displayDayIndex];

                    if (totalCounts.averageSpeedDayLarge > 0) {
                        averageSpeedElement.textContent = `${displayDay}の平均速度の中央値:${totalCounts.averageSpeedDayLarge}km/h`;
                    } else {
                        averageSpeedElement.textContent = `${displayDay}のデータはまだありません`;
                    }
                }
            }

            // 長時間駐車台数グラフの情報を更新
            if (document.getElementById('long-parking-small-info')) {
                const totalElement = document.getElementById('long-parking-small-total');
                const hourlyElement = document.getElementById('long-parking-small-hourly');

                if (totalElement && hourlyElement && chartLatestData.smallLongParkingByHour.data.length > 0) {
                    totalElement.textContent = `${totalCounts.longParkingSmall}台/日`;
                    // 最多時間帯のデータを表示
                    const maxValue = Math.max(...chartLatestData.smallLongParkingByHour.data);
                    const maxIndex = chartLatestData.smallLongParkingByHour.data.indexOf(maxValue);
                    hourlyElement.textContent = `${chartLatestData.smallLongParkingByHour.labels[maxIndex]}:${maxValue}台`;
                }
            }

            if (document.getElementById('long-parking-large-info')) {
                const totalElement = document.getElementById('long-parking-large-total');
                const hourlyElement = document.getElementById('long-parking-large-hourly');

                if (totalElement && hourlyElement && chartLatestData.largeLongParkingByHour.data.length > 0) {
                    totalElement.textContent = `${totalCounts.longParkingLarge}台/日`;
                    // 最多時間帯のデータを表示
                    const maxValue = Math.max(...chartLatestData.largeLongParkingByHour.data);
                    const maxIndex = chartLatestData.largeLongParkingByHour.data.indexOf(maxValue);
                    hourlyElement.textContent = `${chartLatestData.largeLongParkingByHour.labels[maxIndex]}:${maxValue}台`;
                }
            }
        }

        // ページ読み込み完了時に実行
        document.addEventListener('DOMContentLoaded', function () {
            // 長時間駐車台数データを初期化
            initializeLongParkingData();

            // 集計時刻を初期化（ページ読み込み時のみ）
            initializeAggregationTimesOnLoad();
        });

        // 各グラフのデータ更新処理
        function updateAllCharts() {
            const now = new Date();
            let updated = false;

            // 長時間駐車台数モードの場合はデータ更新をスキップ
            if (currentDisplayMode === 'group3') {
                // 長時間駐車台数は静的なデータなので更新しない
                updateChartInfo();
                return;
            }

            // 現在時刻を取得（集計時刻表示用）
            const currentTimeString = getCurrentTimeString().split(' ')[1];

            // 小型車通過台数データを更新
            const smallMainData = processNextData();
            if (smallMainData) {
                updateChartData('smallMainChart', smallMainData.labels, smallMainData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('small-main-aggregation-time', currentTimeString);
                updated = true;
            }

            // 大型車通過台数データを更新
            const largeMainData = processNextDataLarge();
            if (largeMainData) {
                updateChartData('largeMainChart', largeMainData.labels, largeMainData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('large-main-aggregation-time', currentTimeString);
                updated = true;
            }

            // 小型車滞在時間データを更新
            const smallSubData = processNextStayTimeData();
            if (smallSubData) {
                updateChartData('smallSubChart', smallSubData.labels, smallSubData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('small-sub-aggregation-time', currentTimeString);
                updated = true;
            }

            // 大型車滞在時間データを更新
            const largeSubData = processNextLargeStayTimeData();
            if (largeSubData) {
                updateChartData('largeSubChart', largeSubData.labels, largeSubData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('large-sub-aggregation-time', currentTimeString);
                updated = true;
            }

            // 曜日別小型車通過台数データを更新
            const smallDayData = processNextDayData();
            if (smallDayData) {
                updateChartData('smallDayChart', smallDayData.labels, smallDayData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('small-day-aggregation-time', currentTimeString);
                updated = true;
            }

            // 曜日別大型車通過台数データを更新
            const largeDayData = processNextDayDataLarge();
            if (largeDayData) {
                updateChartData('largeDayChart', largeDayData.labels, largeDayData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('large-day-aggregation-time', currentTimeString);
                updated = true;
            }

            // 曜日別小型車滞在時間データを更新
            const smallDayStayTimeData = processNextDayStayTimeData();
            if (smallDayStayTimeData) {
                updateChartData('smallDayStayTimeChart', smallDayStayTimeData.labels, smallDayStayTimeData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateDayStayTimeAggregationTime('small-day-staytime-aggregation-time');
                updated = true;
            }

            // 曜日別大型車滞在時間データを更新
            const largeDayStayTimeData = processNextDayStayTimeDataLarge();
            if (largeDayStayTimeData) {
                updateChartData('largeDayStayTimeChart', largeDayStayTimeData.labels, largeDayStayTimeData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateDayStayTimeAggregationTime('large-day-staytime-aggregation-time');
                updated = true;
            }

            // 道路交通観測の各データ更新
            // 小型車通過台数データを更新
            const trafficSmallData = processNextTrafficSmallData();
            if (trafficSmallData) {
                updateChartData('trafficSmallChart', trafficSmallData.labels, trafficSmallData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('traffic-small-aggregation-time', currentTimeString);
                updated = true;
            }

            // 大型車通過台数データを更新
            const trafficLargeData = processNextTrafficLargeData();
            if (trafficLargeData) {
                updateChartData('trafficLargeChart', trafficLargeData.labels, trafficLargeData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('traffic-large-aggregation-time', currentTimeString);
                updated = true;
            }

            // 小型車平均速度データを更新
            const averageSpeedSmallData = processNextAverageSpeedSmallData();
            if (averageSpeedSmallData) {
                updateChartData('averageSpeedSmallChart', averageSpeedSmallData.labels, averageSpeedSmallData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('average-speed-small-aggregation-time', currentTimeString);
                updated = true;
            }

            // 大型車平均速度データを更新
            const averageSpeedLargeData = processNextAverageSpeedLargeData();
            if (averageSpeedLargeData) {
                updateChartData('averageSpeedLargeChart', averageSpeedLargeData.labels, averageSpeedLargeData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('average-speed-large-aggregation-time', currentTimeString);
                updated = true;
            }

            // 曜日別小型車通過台数データを更新
            const trafficDaySmallData = processNextTrafficDaySmallData();
            if (trafficDaySmallData) {
                updateChartData('trafficDaySmallChart', trafficDaySmallData.labels, trafficDaySmallData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('traffic-day-small-aggregation-time', currentTimeString);
                updated = true;
            }

            // 曜日別大型車通過台数データを更新
            const trafficDayLargeData = processNextTrafficDayLargeData();
            if (trafficDayLargeData) {
                updateChartData('trafficDayLargeChart', trafficDayLargeData.labels, trafficDayLargeData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateAggregationTime('traffic-day-large-aggregation-time', currentTimeString);
                updated = true;
            }

            // 曜日別小型車平均速度データを更新
            const averageSpeedDaySmallData = processNextAverageSpeedDaySmallData();
            if (averageSpeedDaySmallData) {
                updateChartData('averageSpeedDaySmallChart', averageSpeedDaySmallData.labels, averageSpeedDaySmallData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateDayStayTimeAggregationTime('average-speed-day-small-aggregation-time');
                updated = true;
            }

            // 曜日別大型車平均速度データを更新
            const averageSpeedDayLargeData = processNextAverageSpeedDayLargeData();
            if (averageSpeedDayLargeData) {
                updateChartData('averageSpeedDayLargeChart', averageSpeedDayLargeData.labels, averageSpeedDayLargeData.data);
                // 集計時刻を更新（データが更新された時のみ）
                updateDayStayTimeAggregationTime('average-speed-day-large-aggregation-time');
                updated = true;
            }

            // グラフ情報を更新
            updateChartInfo();

            // 最新の時間帯/曜日の色を更新
            if (currentTimeDisplayType === '24h') {
                updateLatestBarColor(); // 24時間表示モードの色更新
                updateTimeBasedColors(); // 0時と12時の色を更新
            } else {
                updateLatestDayBarColor(); // 曜日別表示モードの色更新
            }

            // 更新があった場合は集計時刻を更新
            if (updated) {
                lastUpdateTime = new Date();
                document.getElementById('last-update').textContent = getCurrentTimeString();
            }
        }

        // チャートのデータを更新
        function updateChartData(chartId, labels, data) {
            const chart = chartInstances.find(c => c.id === chartId || c.id === `longparking_${chartId}`);
            if (chart) {
                // 長時間駐車台数グラフは更新しない
                if (chart.isLongParking) {
                    return;
                }
                chart.chart.data.labels = labels;
                chart.chart.data.datasets[0].data = data;
                chart.chart.update();
            }
        }

        // チャートを作成
        function createChart(canvasId, title, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // デフォルトオプション
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            };

            // カスタムオプションをマージ
            const mergedOptions = { ...defaultOptions, ...options };

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: mergedOptions
            });

            // チャートを管理用配列に追加
            chartInstances.push({
                id: canvasId,
                chart: chart
            });

            return chart;
        }

        // 時間帯別大型車滞在時間折れ線グラフを作成
        function createLargeStayTimeLineChart(canvasId, title, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // デフォルトオプション
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            };

            // カスタムオプションをマージ
            const mergedOptions = { ...defaultOptions, ...options };

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: false,
                        tension: 0
                    }]
                },
                options: mergedOptions
            });

            // チャートを管理用配列に追加
            chartInstances.push({
                id: canvasId,
                chart: chart
            });

            return chart;
        }

        // 折れ線グラフを作成
        function createLineChart(canvasId, title, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // デフォルトオプション
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            };

            // カスタムオプションをマージ
            const mergedOptions = { ...defaultOptions, ...options };

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: false,
                        tension: 0
                    }]
                },
                options: mergedOptions
            });

            // チャートを管理用配列に追加
            chartInstances.push({
                id: canvasId,
                chart: chart
            });

            return chart;
        }

        // 長時間駐車台数 時間帯別チャートを作成（カスタム色付き）
        function createLongParking24hChart(canvasId, title, data, options = {}, type) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // 色の設定
            let backgroundColor, borderColor;
            if (type === 'small') {
                // 小型車：オレンジ系
                backgroundColor = Array(24).fill('rgba(255, 159, 64, 0.7)');
                borderColor = Array(24).fill('rgba(255, 159, 64, 1)');
            } else {
                // 大型車：紫系
                backgroundColor = Array(24).fill('rgba(153, 102, 255, 0.7)');
                borderColor = Array(24).fill('rgba(153, 102, 255, 1)');
            }

            // デフォルトオプション
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            };

            // カスタムオプションをマージ
            const mergedOptions = { ...defaultOptions, ...options };

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: mergedOptions
            });

            // チャートを管理用配列に追加
            chartInstances.push({
                id: canvasId,
                chart: chart
            });

            return chart;
        }

        // 長時間駐車台数 曜日別チャートを作成（カスタム色付き）
        function createLongParkingDayChart(canvasId, title, data, options = {}, type) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            const now = new Date();
            const currentDayIndex = now.getDay(); // 0:日曜日, 1:月曜日, ..., 6:土曜日
            const dynamicOrder = generateDynamicDayOrder();

            // 動的順序での本日の曜日のインデックスを取得
            const currentDayName = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'][currentDayIndex];
            const currentDayDynamicIndex = dynamicOrder.indexOf(currentDayName);

            // 色の設定
            let backgroundColor, borderColor;

            if (type === 'small') {
                // 小型車：青緑系 + 本日の曜日は赤色
                backgroundColor = dynamicOrder.map((day, index) => {
                    return index === currentDayDynamicIndex ?
                        'rgba(255, 99, 132, 0.9)' : // 本日の曜日：赤色
                        'rgba(75, 192, 192, 0.7)';   // その他の曜日：青緑色
                });
                borderColor = dynamicOrder.map((day, index) => {
                    return index === currentDayDynamicIndex ?
                        'rgba(255, 99, 132, 1)' :    // 本日の曜日：赤色
                        'rgba(75, 192, 192, 1)';     // その他の曜日：青緑色
                });
            } else {
                // 大型車：金色系 + 本日の曜日は赤色
                backgroundColor = dynamicOrder.map((day, index) => {
                    return index === currentDayDynamicIndex ?
                        'rgba(255, 99, 132, 0.9)' : // 本日の曜日：赤色
                        'rgba(255, 205, 86, 0.7)';   // その他の曜日：金色
                });
                borderColor = dynamicOrder.map((day, index) => {
                    return index === currentDayDynamicIndex ?
                        'rgba(255, 99, 132, 1)' :    // 本日の曜日：赤色
                        'rgba(255, 205, 86, 1)';     // その他の曜日：金色
                });
            }

            // デフォルトオプション
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            };

            // カスタムオプションをマージ
            const mergedOptions = { ...defaultOptions, ...options };

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: mergedOptions
            });

            // チャートを管理用配列に追加
            chartInstances.push({
                id: canvasId,
                chart: chart
            });

            return chart;
        }


        // 長時間駐車台数専用のチャート作成関数（既存のcreateChartを使用しない）
        function createLongParkingChart(canvasId, title, data, options = {}, chartType = '24h', vehicleType = 'small') {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // 色の設定
            let backgroundColor, borderColor;

            if (chartType === '24h') {
                // 時間帯別表示
                if (vehicleType === 'small') {
                    // 小型車：オレンジ系
                    backgroundColor = Array(24).fill('rgba(255, 159, 64, 0.7)');
                    borderColor = Array(24).fill('rgba(255, 159, 64, 1)');
                } else {
                    // 大型車：紫系
                    backgroundColor = Array(24).fill('rgba(153, 102, 255, 0.7)');
                    borderColor = Array(24).fill('rgba(153, 102, 255, 1)');
                }
            } else {
                // 曜日別表示
                const now = new Date();
                const currentDayIndex = now.getDay();
                const dynamicOrder = generateDynamicDayOrder();
                const currentDayName = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'][currentDayIndex];
                const currentDayDynamicIndex = dynamicOrder.indexOf(currentDayName);

                if (vehicleType === 'small') {
                    // 小型車：青緑系 + 本日の曜日は赤色
                    backgroundColor = dynamicOrder.map((day, index) => {
                        return index === currentDayDynamicIndex ?
                            'rgba(255, 99, 132, 0.9)' :
                            'rgba(75, 192, 192, 0.7)';
                    });
                    borderColor = dynamicOrder.map((day, index) => {
                        return index === currentDayDynamicIndex ?
                            'rgba(255, 99, 132, 1)' :
                            'rgba(75, 192, 192, 1)';
                    });
                } else {
                    // 大型車：金色系 + 本日の曜日は赤色
                    backgroundColor = dynamicOrder.map((day, index) => {
                        return index === currentDayDynamicIndex ?
                            'rgba(255, 99, 132, 0.9)' :
                            'rgba(255, 205, 86, 0.7)';
                    });
                    borderColor = dynamicOrder.map((day, index) => {
                        return index === currentDayDynamicIndex ?
                            'rgba(255, 99, 132, 1)' :
                            'rgba(255, 205, 86, 1)';
                    });
                }
            }

            // デフォルトオプション
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: '長時間駐車台数'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            };

            // カスタムオプションをマージ
            const mergedOptions = { ...defaultOptions, ...options };

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: mergedOptions
            });

            // チャートを管理用配列に追加（IDを専用のものに変更して競合を防ぐ）
            const uniqueId = `longparking_${canvasId}`;

            // 既存の同じIDのチャートを削除
            const existingIndex = chartInstances.findIndex(c => c.id === uniqueId);
            if (existingIndex !== -1) {
                chartInstances[existingIndex].chart.destroy();
                chartInstances.splice(existingIndex, 1);
            }

            chartInstances.push({
                id: uniqueId,
                chart: chart,
                isLongParking: true // 長時間駐車台数グラフであることをマーク
            });

            return chart;
        }

        // すべてのチャートをレンダリング
        function renderAllCharts() {
            // 既存のチャートを破棄（長時間駐車台数も含む）
            chartInstances.forEach(chartObj => {
                chartObj.chart.destroy();
            });
            chartInstances = [];

            // チャートコンテナをクリア
            const chartsContainer = document.getElementById('charts-container');
            chartsContainer.innerHTML = '';

            // 現在の表示モードに応じてチャートをレンダリング
            if (currentDisplayMode === 'group1') {
                // 休憩施設利用状況モード
                renderRestFacilityCharts();
            } else if (currentDisplayMode === 'group3') {
                // 長時間駐車台数モード
                renderLongParkingCharts();
            } else {
                // 道路交通観測モード
                renderTrafficObservationCharts();
            }

            // グラフ情報を更新
            updateChartInfo();

            // 時間帯別グラフの色を更新
            if (currentTimeDisplayType === '24h' && currentDisplayMode === 'group1') {
                updateTimeBasedColors();
            }
        }

        // 集計時刻を更新する関数（シンプルに時刻文字列を表示）
        function updateAggregationTime(chartId, timeString) {
            const timeElement = document.getElementById(chartId);
            if (timeElement) {
                timeElement.textContent = `集計時刻: ${timeString}`;
            }
        }

        // 初期表示時に現在時刻で集計時刻を設定する関数を追加
        function initializeAggregationTimesOnLoad() {
            const currentTimeString = getCurrentTimeString().split(' ')[1];

            // 休憩施設利用状況の集計時刻を初期化
            updateAggregationTime('small-main-aggregation-time', currentTimeString);
            updateAggregationTime('large-main-aggregation-time', currentTimeString);
            updateAggregationTime('small-sub-aggregation-time', currentTimeString);
            updateAggregationTime('large-sub-aggregation-time', currentTimeString);
            updateAggregationTime('small-day-aggregation-time', currentTimeString);
            updateAggregationTime('large-day-aggregation-time', currentTimeString);

            // 道路交通観測の集計時刻を初期化
            updateAggregationTime('traffic-small-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-large-aggregation-time', currentTimeString);
            updateAggregationTime('average-speed-small-aggregation-time', currentTimeString);
            updateAggregationTime('average-speed-large-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-day-small-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-day-large-aggregation-time', currentTimeString);

            // 休憩施設長時間駐車台数の集計時刻を初期化
            updateAggregationTime('long-parking-small-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-large-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-day-small-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-day-large-aggregation-time', currentTimeString);
        }

        // 初期表示時の集計時刻を現在時刻で設定する関数を追加
        function initializeAggregationTimes() {
            const now = new Date();
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

            // 休憩施設利用状況の集計時刻を更新
            updateAggregationTime('small-main-aggregation-time', currentTime);
            updateAggregationTime('large-main-aggregation-time', currentTime);
            updateAggregationTime('small-sub-aggregation-time', currentTime);
            updateAggregationTime('large-sub-aggregation-time', currentTime);
            updateAggregationTime('small-day-aggregation-time', currentTime);
            updateAggregationTime('large-day-aggregation-time', currentTime);

            // 道路交通観測の集計時刻を更新
            updateAggregationTime('traffic-small-aggregation-time', currentTime);
            updateAggregationTime('traffic-large-aggregation-time', currentTime);
            updateAggregationTime('average-speed-small-aggregation-time', currentTime);
            updateAggregationTime('average-speed-large-aggregation-time', currentTime);
            updateAggregationTime('traffic-day-small-aggregation-time', currentTime);
            updateAggregationTime('traffic-day-large-aggregation-time', currentTime);
        }

        // 前日の曜日と23:59:59の時刻文字列を生成する関数
        function getPreviousDayAggregationTime() {
            const now = new Date();
            const currentDayIndex = now.getDay(); // 0:日曜日, 1:月曜日, ..., 6:土曜日

            // 曜日の配列
            const days = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];

            // 前日の曜日インデックスを計算
            const previousDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;
            const previousDay = days[previousDayIndex];

            return `${previousDay} 23:59:59`;
        }

        // 曜日別滞在時間の集計時刻を更新する関数
        function updateDayStayTimeAggregationTime(chartId) {
            const timeElement = document.getElementById(chartId);
            if (timeElement) {
                timeElement.textContent = `集計時刻: ${getPreviousDayAggregationTime()}`;
            }
        }

        // 曜日別滞在時間の集計時刻をリセットする関数
        function resetDayStayTimeAggregationTime(chartId) {
            const timeElement = document.getElementById(chartId);
            if (timeElement) {
                timeElement.textContent = '集計時刻: --曜日 23:59:59';
            }
        }

        // 時間タイプ切り替え
        function changeTimeType(timeType) {
            currentTimeDisplayType = timeType;

            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.btn-time-switcher').forEach(btn => {
                btn.classList.remove('active');
            });

            document.querySelectorAll('.btn-time-switcher').forEach(btn => {
                if (btn.textContent.includes(timeType === '24h' ? '時間帯別' : '曜日別')) {
                    btn.classList.add('active');
                }
            });

            // 集計時刻を現在時刻でリセット
            const currentTimeString = getCurrentTimeString().split(' ')[1];

            // 休憩施設利用状況の集計時刻をリセット
            updateAggregationTime('small-main-aggregation-time', currentTimeString);
            updateAggregationTime('large-main-aggregation-time', currentTimeString);
            updateAggregationTime('small-sub-aggregation-time', currentTimeString);
            updateAggregationTime('large-sub-aggregation-time', currentTimeString);
            updateAggregationTime('small-day-aggregation-time', currentTimeString);
            updateAggregationTime('large-day-aggregation-time', currentTimeString);
            resetDayStayTimeAggregationTime('small-day-staytime-aggregation-time');
            resetDayStayTimeAggregationTime('large-day-staytime-aggregation-time');

            // 道路交通観測の集計時刻をリセット
            updateAggregationTime('traffic-small-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-large-aggregation-time', currentTimeString);
            updateAggregationTime('average-speed-small-aggregation-time', currentTimeString);
            updateAggregationTime('average-speed-large-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-day-small-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-day-large-aggregation-time', currentTimeString);
            resetDayStayTimeAggregationTime('average-speed-day-small-aggregation-time');
            resetDayStayTimeAggregationTime('average-speed-day-large-aggregation-time');

            // 休憩施設長時間駐車台数の集計時刻を初期化
            updateAggregationTime('long-parking-small-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-large-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-day-small-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-day-large-aggregation-time', currentTimeString);

            // 集計時刻をリセット

            // メインタイトルを更新（色も変更される）
            updateMainTitle();
            renderAllCharts();
            resetChartUpdateTimer(); // タイマーリセット
        }

        // 表示モード切り替え
        function changeView(viewType) {
            currentDisplayMode = viewType;

            // 集計時刻を現在時刻でリセット
            const currentTimeString = getCurrentTimeString().split(' ')[1];

            // 休憩施設利用状況の集計時刻をリセット
            updateAggregationTime('small-main-aggregation-time', currentTimeString);
            updateAggregationTime('large-main-aggregation-time', currentTimeString);
            updateAggregationTime('small-sub-aggregation-time', currentTimeString);
            updateAggregationTime('large-sub-aggregation-time', currentTimeString);
            updateAggregationTime('small-day-aggregation-time', currentTimeString);
            updateAggregationTime('large-day-aggregation-time', currentTimeString);
            resetDayStayTimeAggregationTime('small-day-staytime-aggregation-time');
            resetDayStayTimeAggregationTime('large-day-staytime-aggregation-time');

            // 道路交通観測の集計時刻をリセット
            updateAggregationTime('traffic-small-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-large-aggregation-time', currentTimeString);
            updateAggregationTime('average-speed-small-aggregation-time', currentTimeString);
            updateAggregationTime('average-speed-large-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-day-small-aggregation-time', currentTimeString);
            updateAggregationTime('traffic-day-large-aggregation-time', currentTimeString);
            resetDayStayTimeAggregationTime('average-speed-day-small-aggregation-time');
            resetDayStayTimeAggregationTime('average-speed-day-large-aggregation-time');


            // 休憩施設長時間駐車台数の集計時刻を初期化
            updateAggregationTime('long-parking-small-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-large-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-day-small-aggregation-time', currentTimeString);
            updateAggregationTime('long-parking-day-large-aggregation-time', currentTimeString);

            updateMainTitle();
            renderAllCharts();
            resetChartUpdateTimer(); // タイマーリセット
        }

        // renderRestFacilityCharts関数に曜日別グラフの表示を追加
        function renderRestFacilityCharts() {
            const chartsContainer = document.getElementById('charts-container');

            if (currentTimeDisplayType === '24h') {
                // 24時間表示モード

                // 通過台数サブタイトル追加
                chartsContainer.innerHTML += `
                <div class="subtitle">車種別 通過台数モニター</div>
                <div class="charts-row">
            `;

                // 小型車通過台数グラフ
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">小型車</h3>
                            <div class="aggregation-time" id="small-main-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="small-main-info">
                            <div class="info-item">
                                <span class="info-label">累計</span>
                                <span class="info-value" id="small-main-total">0台/日</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">単時間合計</span>
                                <span class="info-value" id="small-main-hourly">0台</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="smallMainChart"></canvas>
                    </div>
                </div>
            `;

                // 大型車通過台数グラフ
                chartsContainer.innerHTML += `
                <!-- 大型車通過台数グラフ -->
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">大型車</h3>
                            <div class="aggregation-time" id="large-main-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="large-main-info">
                            <div class="info-item">
                                <span class="info-label">累計</span>
                                <span class="info-value" id="large-main-total">0台/日</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">単時間合計</span>
                                <span class="info-value" id="large-main-hourly">0台</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="largeMainChart"></canvas>
                    </div>
                </div>
            `;

                chartsContainer.innerHTML += `</div>`; // charts-row 終了

                // 滞在時間サブタイトル追加
                chartsContainer.innerHTML += `
                <div class="subtitle">車種別 滞在時間モニター</div>
                <div class="charts-row">
            `;

                // 小型車滞在時間グラフ
                chartsContainer.innerHTML += `
                <!-- 小型車滞在時間グラフ -->
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">小型車</h3>
                            <div class="aggregation-time" id="small-sub-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="small-sub-info">
                            <div class="info-item">
                                <span class="info-value" id="small-sub-staytime">--時の滞在時間の中央値:--分</span>
                            </div>
                        </div>
                    </div>
                    <div class="line-chart-container">
                        <canvas id="smallSubChart"></canvas>
                    </div>
                </div>
            `;

                // 大型車滞在時間グラフ
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">大型車</h3>
                            <div class="aggregation-time" id="large-sub-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="large-sub-info">
                            <div class="info-item">
                                <span class="info-value" id="large-sub-staytime">--時の滞在時間の中央値:--分</span>
                            </div>
                        </div>
                    </div>
                    <div class="line-chart-container">
                        <canvas id="largeSubChart"></canvas>
                    </div>
                </div>
            `;

                chartsContainer.innerHTML += `</div>`; // charts-row 終了

                // チャートを作成
                createChart('smallMainChart', '小型車通過台数', chartLatestData.smallInflowsCountByHour, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '通過台数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            },
                            ticks: {
                                maxTicksLimit: 24,
                                autoSkip: false
                            }
                        }
                    }
                });

                createChart('largeMainChart', '大型車通過台数', chartLatestData.largeInflowsCountByHour, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '通過台数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            },
                            ticks: {
                                maxTicksLimit: 24,
                                autoSkip: false
                            }
                        }
                    }
                });

                createLineChart('smallSubChart', '小型車滞在時間', chartLatestData.smallStayTimeByHour, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '滞在時間の中央値（分）'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            }
                        }
                    }
                });

                createLargeStayTimeLineChart('largeSubChart', '大型車滞在時間', chartLatestData.largeStayTimeByHour, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '滞在時間の中央値（分）'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            }
                        }
                    }
                });

                // 最新の時間帯の棒グラフの色を変更
                updateLatestBarColor();
            } else {
                // 曜日別表示モード

                // 通過台数サブタイトル追加
                chartsContainer.innerHTML += `
                <div class="subtitle">車種別 通過台数モニター</div>
                <div class="charts-row">
            `;

                // 小型車通過台数グラフ
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                         <div class="chart-title-container">
                            <h3 class="chart-title">小型車</h3>
                            <div class="aggregation-time" id="small-day-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        </div>
                        <div class="chart-info" id="small-day-info">
                            <div class="info-item">
                                <span class="info-label">累計</span>
                                <span class="info-value" id="small-day-total">0台/週</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">曜日別合計</span>
                                <span class="info-value" id="small-day-daily">0台</span>
                            </div>
                        </div>
                    </div>
                    <div class="day-chart-container">
                        <canvas id="smallDayChart"></canvas>
                    </div>
                </div>
            `;

                // 大型車通過台数グラフ
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">大型車</h3>
                            <div class="aggregation-time" id="large-day-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="large-day-info">
                            <div class="info-item">
                                <span class="info-label">累計</span>
                                <span class="info-value" id="large-day-total">0台/週</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">曜日別合計</span>
                                <span class="info-value" id="large-day-daily">0台</span>
                            </div>
                        </div>
                    </div>
                    <div class="day-chart-container">
                        <canvas id="largeDayChart"></canvas>
                    </div>
                </div>
            `;

                chartsContainer.innerHTML += `</div>`;

                // 滞在時間サブタイトル追加
                chartsContainer.innerHTML += `
                <div class="subtitle">車種別 滞在時間モニター</div>
                <div class="charts-row">
            `;

                // 小型車滞在時間グラフ
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">小型車</h3>
                            <div class="aggregation-time" id="small-day-staytime-aggregation-time">
                                集計時刻: --曜日 23:59:59
                            </div>
                        </div>
                        <div class="chart-info" id="small-day-staytime-info">
                            <div class="info-item">
                                <span class="info-value" id="small-day-staytime-value">--曜日の滞在時間の中央値:--分</span>
                            </div>
                        </div>
                    </div>
                    <div class="day-line-chart-container">
                        <canvas id="smallDayStayTimeChart"></canvas>
                    </div>
                </div>
            `;

                // 大型車滞在時間グラフ
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">大型車</h3>
                            <div class="aggregation-time" id="large-day-staytime-aggregation-time">
                                集計時刻: --曜日 23:59:59
                            </div>
                        </div>
                        <div class="chart-info" id="large-day-staytime-info">
                            <div class="info-item">
                                <span class="info-value" id="large-day-staytime-value">--曜日の滞在時間の中央値:--分</span>
                            </div>
                        </div>
                    </div>
                    <div class="day-line-chart-container">
                        <canvas id="largeDayStayTimeChart"></canvas>
                    </div>
                </div>
            `;

                chartsContainer.innerHTML += `</div>`;

                // チャートを作成
                createChart('smallDayChart', '小型車通過台数', chartLatestData.smallInflowsCounByDay, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '通過台数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                });

                createChart('largeDayChart', '大型車通過台数', chartLatestData.largeInflowsCountByDay, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '通過台数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                });

                // チャートを作成後に集計時刻を初期設定
                createLineChart('smallDayStayTimeChart', '小型車滞在時間', chartLatestData.smallStayTimeByDay, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '滞在時間の中央値（分）'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                });

                // 大型車滞在時間グラフを作成
                createLargeStayTimeLineChart('largeDayStayTimeChart', '大型車滞在時間', chartLatestData.largeStayTimeByDay, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '滞在時間の中央値（分）'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                });

                // 集計時刻を初期表示
                updateDayStayTimeAggregationTime('small-day-staytime-aggregation-time');
                updateDayStayTimeAggregationTime('large-day-staytime-aggregation-time');

                // 最新の曜日の棒グラフの色を変更
                updateLatestDayBarColor();
            }

            // グラフ情報を更新
            updateChartInfo();
        }

        // 道路交通観測のチャートをレンダリング
        function renderTrafficObservationCharts() {
            const chartsContainer = document.getElementById('charts-container');

            if (currentTimeDisplayType === '24h') {
                // 24時間表示モード

                // 通過台数サブタイトル追加
                chartsContainer.innerHTML += `
                <div class="subtitle">車種別 通過台数モニター</div>
                <div class="charts-row">
            `;

                // 道路交通観測 小型車通過台数グラフ
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">小型車</h3>
                            <div class="aggregation-time" id="traffic-small-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="traffic-small-info">
                            <div class="info-item">
                                <span class="info-label">累計</span>
                                <span class="info-value" id="traffic-small-total">0台/日</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">単時間合計</span>
                                <span class="info-value" id="traffic-small-hourly">0台</span>
                            </div>
                        </div>
                    </div>
                    <div class="traffic-chart-container">
                        <canvas id="trafficSmallChart"></canvas>
                    </div>
                </div>
            `;

                // 道路交通観測 大型車通過台数グラフ
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">大型車</h3>
                            <div class="aggregation-time" id="traffic-large-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="traffic-large-info">
                            <div class="info-item">
                                <span class="info-label">累計</span>
                                <span class="info-value" id="traffic-large-total">0台/日</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">単時間合計</span>
                                <span class="info-value" id="traffic-large-hourly">0台</span>
                            </div>
                        </div>
                    </div>
                    <div class="traffic-chart-container">
                        <canvas id="trafficLargeChart"></canvas>
                    </div>
                </div>
            `;

                chartsContainer.innerHTML += `</div>`; // charts-row 終了

                // 平均速度サブタイトル追加
                chartsContainer.innerHTML += `
                <div class="subtitle">車種別 平均速度モニター</div>
                <div class="charts-row">
            `;

                // 小型車平均速度グラフ
                chartsContainer.innerHTML += `
                <!-- 小型車平均速度グラフ -->
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">小型車</h3>
                            <div class="aggregation-time" id="average-speed-small-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="average-speed-small-info">
                            <div class="info-item">
                                <span class="info-value" id="average-speed-small-value">--時の平均速度の中央値:--km/h</span>
                            </div>
                        </div>
                    </div>
                    <div class="average-speed-chart-container">
                        <canvas id="averageSpeedSmallChart"></canvas>
                    </div>
                </div>
            `;

                // 大型車平均速度グラフ
                chartsContainer.innerHTML += `
                <!-- 大型車平均速度グラフ -->
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">大型車</h3>
                            <div class="aggregation-time" id="average-speed-large-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="average-speed-large-info">
                            <div class="info-item">
                                <span class="info-value" id="average-speed-large-value">--時の平均速度の中央値:--km/h</span>
                            </div>
                        </div>
                    </div>
                    <div class="average-speed-chart-container">
                        <canvas id="averageSpeedLargeChart"></canvas>
                    </div>
                </div>
            `;

                chartsContainer.innerHTML += `</div>`; // charts-row 終了

                // チャートを作成
                createChart('trafficSmallChart', '道路交通観測 小型車通過台数', chartLatestData.smallTrafficCountByHour, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '通過台数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            },
                            ticks: {
                                maxTicksLimit: 24,
                                autoSkip: false
                            }
                        }
                    }
                });

                createChart('trafficLargeChart', '道路交通観測 大型車通過台数', chartLatestData.largeTrafficCountByHour, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '通過台数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            },
                            ticks: {
                                maxTicksLimit: 24,
                                autoSkip: false
                            }
                        }
                    }
                });

                createLineChart('averageSpeedSmallChart', '小型車平均速度', chartLatestData.smallAverageSpeedByHour, {
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '平均速度の中央値（km/h）'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            }
                        }
                    }
                });

                createLargeStayTimeLineChart('averageSpeedLargeChart', '大型車平均速度', chartLatestData.largeAverageSpeedByHour, {
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '平均速度の中央値（km/h）'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '時間'
                            }
                        }
                    }
                });

                // 最新の時間帯の棒グラフの色を変更
                updateLatestBarColor();
            } else {
                // 曜日別表示モード

                // 通過台数サブタイトル追加
                chartsContainer.innerHTML += `
                <div class="subtitle">車種別 通過台数モニター</div>
                <div class="charts-row">
            `;

                // 道路交通観測 小型車通過台数グラフ（曜日別）
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">小型車</h3>
                            <div class="aggregation-time" id="traffic-day-small-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="traffic-day-small-info">
                            <div class="info-item">
                                <span class="info-label">累計</span>
                                <span class="info-value" id="traffic-day-small-total">0台/週</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">曜日別合計</span>
                                <span class="info-value" id="traffic-day-small-daily">0台</span>
                            </div>
                        </div>
                    </div>
                    <div class="traffic-day-chart-container">
                        <canvas id="trafficDaySmallChart"></canvas>
                    </div>
                </div>
            `;

                // 道路交通観測 大型車通過台数グラフ（曜日別）
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">大型車</h3>
                            <div class="aggregation-time" id="traffic-day-large-aggregation-time">
                                集計時刻: ${getCurrentTimeString().split(' ')[1]}
                            </div>
                        </div>
                        <div class="chart-info" id="traffic-day-large-info">
                            <div class="info-item">
                                <span class="info-label">累計</span>
                                <span class="info-value" id="traffic-day-large-total">0台/週</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">曜日別合計</span>
                                <span class="info-value" id="traffic-day-large-daily">0台</span>
                            </div>
                        </div>
                    </div>
                    <div class="traffic-day-chart-container">
                        <canvas id="trafficDayLargeChart"></canvas>
                    </div>
                </div>
            `;

                chartsContainer.innerHTML += `</div>`;

                // 平均速度サブタイトル追加
                chartsContainer.innerHTML += `
                <div class="subtitle">車種別 平均速度モニター</div>
                <div class="charts-row">
            `;

                // 小型車平均速度グラフ（曜日別）
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">小型車</h3>
                            <div class="aggregation-time" id="average-speed-day-small-aggregation-time">
                                集計時刻: --曜日 23:59:59
                            </div>
                        </div>
                        <div class="chart-info" id="average-speed-day-small-info">
                            <div class="info-item">
                                <span class="info-value" id="average-speed-day-small-value">--曜日の平均速度の中央値:--km/h</span>
                            </div>
                        </div>
                    </div>
                    <div class="average-speed-day-chart-container">
                        <canvas id="averageSpeedDaySmallChart"></canvas>
                    </div>
                </div>
            `;

                // 大型車平均速度グラフ（曜日別）
                chartsContainer.innerHTML += `
                <div class="chart-box">
                    <div class="chart-header">
                        <div class="chart-title-container">
                            <h3 class="chart-title">大型車</h3>
                            <div class="aggregation-time" id="average-speed-day-large-aggregation-time">
                                集計時刻: --曜日 23:59:59
                            </div>
                        </div>
                        <div class="chart-info" id="average-speed-day-large-info">
                            <div class="info-item">
                                <span class="info-value" id="average-speed-day-large-value">--曜日の平均速度の中央値:--km/h</span>
                            </div>
                        </div>
                    </div>
                    <div class="average-speed-day-chart-container">
                        <canvas id="averageSpeedDayLargeChart"></canvas>
                    </div>
                </div>
            `;

                chartsContainer.innerHTML += `</div>`;

                // チャートを作成
                createChart('trafficDaySmallChart', '道路交通観測 小型車通過台数（曜日別）', chartLatestData.smallTrafficCountByDay, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '通過台数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                });

                createChart('trafficDayLargeChart', '道路交通観測 大型車通過台数（曜日別）', chartLatestData.largeTrafficCountByDay, {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '通過台数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                });

                // 小型車平均速度グラフ（曜日別）を作成
                createLineChart('averageSpeedDaySmallChart', '小型車平均速度（曜日別）', chartLatestData.smallAverageSpeedByDay, {
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '平均速度の中央値（km/h）'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                });

                // 大型車平均速度グラフ（曜日別）を作成
                createLargeStayTimeLineChart('averageSpeedDayLargeChart', '大型車平均速度（曜日別）', chartLatestData.largeAverageSpeedByDay, {
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '平均速度の中央値（km/h）'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                });

                // 集計時刻を初期表示（追加）
                updateDayStayTimeAggregationTime('average-speed-day-small-aggregation-time');
                updateDayStayTimeAggregationTime('average-speed-day-large-aggregation-time');

                // 最新の曜日の棒グラフの色を変更
                updateLatestDayBarColor();
            }

            // グラフ情報を更新
            updateChartInfo();
        }

        // 長時間駐車台数のチャートをレンダリング
        function renderLongParkingCharts() {
            const chartsContainer = document.getElementById('charts-container');

            // 既存の長時間駐車台数チャートを破棄
            chartInstances.forEach((chartObj, index) => {
                if (chartObj.isLongParking) {
                    chartObj.chart.destroy();
                    chartInstances.splice(index, 1);
                }
            });

            if (currentTimeDisplayType === '24h') {
                // 24時間表示モード

                // 長時間駐車台数サブタイトル追加
                chartsContainer.innerHTML += `
            <div class="subtitle">車種別 長時間駐車台数モニター</div>
            <div class="charts-row">
        `;

                // 小型車長時間駐車台数グラフ
                chartsContainer.innerHTML += `
            <div class="chart-box">
                <div class="chart-header">
                    <div class="chart-title-container">
                        <h3 class="chart-title">小型車</h3>
                        <div class="aggregation-time" id="long-parking-small-aggregation-time">
                            集計時刻: ${getCurrentTimeString().split(' ')[1]}
                        </div>
                    </div>
                    <div class="chart-info" id="long-parking-small-info">
                        <div class="info-item">
                            <span class="info-label">累計</span>
                            <span class="info-value" id="long-parking-small-total">${totalCounts.longParkingSmall}台/日</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">最多時間帯</span>
                            <span class="info-value" id="long-parking-small-hourly">${Math.max(...chartLatestData.smallLongParkingByHour.data)}台</span>
                        </div>
                    </div>
                </div>
                <div class="long-parking-chart-container">
                    <canvas id="longParkingSmallChart"></canvas>
                </div>
            </div>
        `;

                // 大型車長時間駐車台数グラフ
                chartsContainer.innerHTML += `
            <div class="chart-box">
                <div class="chart-header">
                    <div class="chart-title-container">
                        <h3 class="chart-title">大型車</h3>
                        <div class="aggregation-time" id="long-parking-large-aggregation-time">
                            集計時刻: ${getCurrentTimeString().split(' ')[1]}
                        </div>
                    </div>
                    <div class="chart-info" id="long-parking-large-info">
                        <div class="info-item">
                            <span class="info-label">累計</span>
                            <span class="info-value" id="long-parking-large-total">${totalCounts.longParkingLarge}台/日</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">最多時間帯</span>
                            <span class="info-value" id="long-parking-large-hourly">${Math.max(...chartLatestData.largeLongParkingByHour.data)}台</span>
                        </div>
                    </div>
                </div>
                <div class="long-parking-chart-container">
                    <canvas id="longParkingLargeChart"></canvas>
                </div>
            </div>
        `;

                chartsContainer.innerHTML += `</div>`; // charts-row 終了

                // 専用関数でチャートを作成
                createLongParkingChart('longParkingSmallChart', '小型車長時間駐車台数', chartLatestData.smallLongParkingByHour, {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '滞在時間'
                            },
                            ticks: {
                                maxTicksLimit: 12,
                                autoSkip: true
                            }
                        }
                    }
                }, '24h', 'small');

                createLongParkingChart('longParkingLargeChart', '大型車長時間駐車台数', chartLatestData.largeLongParkingByHour, {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '滞在時間'
                            },
                            ticks: {
                                maxTicksLimit: 12,
                                autoSkip: true
                            }
                        }
                    }
                }, '24h', 'large');

            } else {
                // 曜日別表示モード

                // 長時間駐車台数サブタイトル追加
                chartsContainer.innerHTML += `
            <div class="subtitle">車種別 長時間駐車台数モニター</div>
            <div class="charts-row">
        `;

                // 小型車長時間駐車台数グラフ（曜日別）
                chartsContainer.innerHTML += `
            <div class="chart-box">
                <div class="chart-header">
                    <div class="chart-title-container">
                        <h3 class="chart-title">小型車</h3>
                        <div class="aggregation-time" id="long-parking-day-small-aggregation-time">
                            集計時刻: ${getCurrentTimeString().split(' ')[1]}
                        </div>
                    </div>
                    <div class="chart-info" id="long-parking-day-small-info">
                        <div class="info-item">
                            <span class="info-label">累計</span>
                            <span class="info-value" id="long-parking-day-small-total">${totalCounts.longParkingDaySmall}台/週</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">曜日別合計</span>
                            <span class="info-value" id="long-parking-day-small-daily">${chartLatestData.smallLongParkingByDay.data[chartLatestData.smallLongParkingByDay.data.length - 1] || 0}台</span>
                        </div>
                    </div>
                </div>
                <div class="long-parking-day-chart-container">
                    <canvas id="longParkingDaySmallChart"></canvas>
                </div>
            </div>
        `;

                // 大型車長時間駐車台数グラフ（曜日別）
                chartsContainer.innerHTML += `
            <div class="chart-box">
                <div class="chart-header">
                    <div class="chart-title-container">
                        <h3 class="chart-title">大型車</h3>
                        <div class="aggregation-time" id="long-parking-day-large-aggregation-time">
                            集計時刻: ${getCurrentTimeString().split(' ')[1]}
                        </div>
                    </div>
                    <div class="chart-info" id="long-parking-day-large-info">
                        <div class="info-item">
                            <span class="info-label">累計</span>
                            <span class="info-value" id="long-parking-day-large-total">${totalCounts.longParkingDayLarge}台/週</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">曜日別合計</span>
                            <span class="info-value" id="long-parking-day-large-daily">${chartLatestData.largeLongParkingByDay.data[chartLatestData.largeLongParkingByDay.data.length - 1] || 0}台</span>
                        </div>
                    </div>
                </div>
                <div class="long-parking-day-chart-container">
                    <canvas id="longParkingDayLargeChart"></canvas>
                </div>
            </div>
        `;

                chartsContainer.innerHTML += `</div>`; // charts-row 終了

                // 専用関数でチャートを作成
                createLongParkingChart('longParkingDaySmallChart', '小型車長時間駐車台数（曜日別）', chartLatestData.smallLongParkingByDay, {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                }, 'day', 'small');

                createLongParkingChart('longParkingDayLargeChart', '大型車長時間駐車台数（曜日別）', chartLatestData.largeLongParkingByDay, {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '曜日'
                            }
                        }
                    }
                }, 'day', 'large');
            }

            // グラフ情報を更新
            updateChartInfo();
        }



        // 最新の時間帯の棒グラフ/折れ線グラフの色を変更
        function updateLatestBarColor() {
            const now = new Date();
            const currentHour = now.getHours();
            // ★★★ 21時起点のインデックスに変換 ★★★
            const shiftedCurrentHour = getShiftedHourIndex(currentHour);

            chartInstances.forEach(chartObj => {
                // 休憩施設利用状況のグラフはupdateTimeBasedColorsで処理するのでスキップ
                const restFacilityCharts = ['smallMainChart', 'largeMainChart', 'smallSubChart', 'largeSubChart'];
                if (restFacilityCharts.includes(chartObj.id)) {
                    return; // スキップ
                }

                const chart = chartObj.chart;
                const datasets = chart.data.datasets;

                // 折れ線グラフの場合
                if (chart.config.type === 'line') {
                    datasets.forEach(dataset => {
                        // すべてのポイントの色をリセット
                        if (!Array.isArray(dataset.pointBackgroundColor)) {
                            // グラフタイプに応じたデフォルト色を設定
                            if (chartObj.id === 'smallSubChart') {
                                dataset.pointBackgroundColor = Array(24).fill('rgba(54, 162, 235, 1)'); // 青色
                            } else if (chartObj.id === 'largeSubChart') {
                                dataset.pointBackgroundColor = Array(24).fill('rgba(75, 192, 192, 1)'); // 緑色
                            } else if (chartObj.id === 'averageSpeedSmallChart') {
                                dataset.pointBackgroundColor = Array(24).fill('rgba(54, 162, 235, 1)'); // 青色
                            } else if (chartObj.id === 'averageSpeedLargeChart') {
                                dataset.pointBackgroundColor = Array(24).fill('rgba(75, 192, 192, 1)'); // 緑色
                            } else {
                                dataset.pointBackgroundColor = Array(24).fill('rgba(54, 162, 235, 1)');
                            }
                            dataset.pointBorderColor = Array(24).fill('#fff');
                        }

                        // ハイライトする時間帯を決定
                        let highlightHour = currentHour;
                        // ハイライトする時間帯を決定（21時起点）
                        let highlightHour21Start = shiftedCurrentHour;

                        // 滞在時間グラフの場合は21時起点として1つ前の時間帯をハイライト
                        if (chartObj.id === 'smallSubChart' || chartObj.id === 'largeSubChart') {
                            highlightHour21Start = shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1;
                        }
                        // 平均速度グラフの場合は1つ前の時間帯をハイライト
                        if (chartObj.id === 'averageSpeedSmallChart' || chartObj.id === 'averageSpeedLargeChart') {
                            highlightHour = currentHour === 0 ? 23 : currentHour - 1;
                        }

                        // 最新の時間帯のポイントの色を変更
                        for (let i = 0; i < 24; i++) {
                            if (i === highlightHour21Start) {
                                // 滞在時間グラフはオレンジ色でハイライト
                                if (chartObj.id === 'smallSubChart' || chartObj.id === 'largeSubChart') {
                                    dataset.pointBackgroundColor[i] = 'rgba(255, 159, 64, 1)';
                                    dataset.pointBorderColor[i] = '#fff';
                                }
                                dataset.pointRadius = 6; // ハイライトポイントは少し大きく
                            } else if (i === highlightHour) {
                                // 平均速度グラフは赤色でハイライト
                                if (chartObj.id === 'averageSpeedSmallChart' || chartObj.id === 'averageSpeedLargeChart') {
                                    dataset.pointBackgroundColor[i] = 'rgba(255, 99, 132, 1)';
                                    dataset.pointBorderColor[i] = '#fff';
                                }
                                dataset.pointRadius = 6; // ハイライトポイントは少し大きく
                            } else {
                                // 通常の色 - グラフタイプに応じた色を設定
                                if (chartObj.id === 'smallSubChart') {
                                    // 小型車滞在時間は青色
                                    dataset.pointBackgroundColor[i] = 'rgba(54, 162, 235, 1)';
                                    dataset.pointBorderColor[i] = '#fff';
                                } else if (chartObj.id === 'largeSubChart') {
                                    // 大型車滞在時間は緑色
                                    dataset.pointBackgroundColor[i] = 'rgba(75, 192, 192, 1)';
                                    dataset.pointBorderColor[i] = '#fff';
                                } else if (chartObj.id === 'averageSpeedSmallChart') {
                                    // 小型車平均速度は青色
                                    dataset.pointBackgroundColor[i] = 'rgba(54, 162, 235, 1)';
                                    dataset.pointBorderColor[i] = '#fff';
                                } else if (chartObj.id === 'averageSpeedLargeChart') {
                                    // 大型車平均速度は緑色
                                    dataset.pointBackgroundColor[i] = 'rgba(75, 192, 192, 1)';
                                    dataset.pointBorderColor[i] = '#fff';
                                }
                                dataset.pointRadius = 4;
                            }
                        }
                    });
                }
                // 棒グラフの場合
                else {
                    datasets.forEach(dataset => {
                        if (!Array.isArray(dataset.backgroundColor)) {
                            // グラフタイプに応じたデフォルト色を設定
                            if (chartObj.id === 'smallMainChart') {
                                dataset.backgroundColor = Array(24).fill('rgba(54, 162, 235, 0.5)'); // 青色
                                dataset.borderColor = Array(24).fill('rgba(54, 162, 235, 1)');
                            } else if (chartObj.id === 'largeMainChart') {
                                dataset.backgroundColor = Array(24).fill('rgba(75, 192, 192, 0.5)'); // 緑色
                                dataset.borderColor = Array(24).fill('rgba(75, 192, 192, 1)');
                            } else if (chartObj.id === 'trafficSmallChart') {
                                dataset.backgroundColor = Array(24).fill('rgba(30, 100, 200, 0.5)');
                                dataset.borderColor = Array(24).fill('rgba(30, 100, 200, 1)');
                            } else if (chartObj.id === 'trafficLargeChart') {
                                dataset.backgroundColor = Array(24).fill('rgba(50, 150, 100, 0.5)');
                                dataset.borderColor = Array(24).fill('rgba(50, 150, 100, 1)');
                            } else {
                                dataset.backgroundColor = Array(24).fill('rgba(54, 162, 235, 0.5)');
                                dataset.borderColor = Array(24).fill('rgba(54, 162, 235, 1)');
                            }
                        }

                        // チャートIDで判定してハイライトする時間帯を変更
                        let highlightHour = currentHour;
                        // チャートIDで判定してハイライトする時間帯を変更（21時起点）
                        let highlightHour21Start = shiftedCurrentHour;

                        // 最新の時間帯の色を変更
                        for (let i = 0; i < 24; i++) {
                            if (i === highlightHour21Start) {
                                if (chartObj.id === 'smallMainChart' || chartObj.id === 'largeMainChart') {
                                    // 通過台数グラフは赤色でハイライト
                                    if (chartObj.id === 'smallMainChart') {
                                        dataset.backgroundColor[i] = 'rgba(255, 99, 132, 0.7)';
                                        dataset.borderColor[i] = 'rgba(255, 99, 132, 1)';
                                    } else if (chartObj.id === 'largeMainChart') {
                                        dataset.backgroundColor[i] = 'rgba(255, 99, 132, 0.7)';
                                        dataset.borderColor[i] = 'rgba(255, 99, 132, 1)';
                                    }
                                }
                            } else if (i === highlightHour) {
                                // グラフタイプによってハイライト色を分ける
                                if (chartObj.id === 'trafficSmallChart' || chartObj.id === 'trafficLargeChart') {
                                    // 道路交通観測グラフは紫色でハイライト
                                    dataset.backgroundColor[i] = 'rgba(153, 102, 255, 0.7)';
                                    dataset.borderColor[i] = 'rgba(153, 102, 255, 1)';
                                }
                            } else {
                                // 通常の色（グラフタイプによって色を分ける）
                                if (chartObj.id === 'smallMainChart') {
                                    // 小型車は青色
                                    dataset.backgroundColor[i] = 'rgba(54, 162, 235, 0.5)';
                                    dataset.borderColor[i] = 'rgba(54, 162, 235, 1)';
                                } else if (chartObj.id === 'largeMainChart') {
                                    // 大型車は緑色
                                    dataset.backgroundColor[i] = 'rgba(75, 192, 192, 0.5)';
                                    dataset.borderColor[i] = 'rgba(75, 192, 192, 1)';
                                } else if (chartObj.id === 'trafficSmallChart') {
                                    // 道路交通観測 小型車は青色系（濃い）
                                    dataset.backgroundColor[i] = 'rgba(30, 100, 200, 0.5)';
                                    dataset.borderColor[i] = 'rgba(30, 100, 200, 1)';
                                } else if (chartObj.id === 'trafficLargeChart') {
                                    // 道路交通観測 大型車は緑色系（濃い）
                                    dataset.backgroundColor[i] = 'rgba(50, 150, 100, 0.5)';
                                    dataset.borderColor[i] = 'rgba(50, 150, 100, 1)';
                                } else {
                                    // その他のグラフはデフォルトの青色
                                    dataset.backgroundColor[i] = 'rgba(54, 162, 235, 0.5)';
                                    dataset.borderColor[i] = 'rgba(54, 162, 235, 1)';
                                }
                            }
                        }
                    });
                }

                chart.update();
            });
        }

        // 最新の曜日の棒グラフの色を変更する関数 - 動的順序対応
        function updateLatestDayBarColor() {
            const now = new Date();
            const dynamicOrder = generateDynamicDayOrder();

            // 最新の曜日（右端）のインデックス
            const latestDayIndex = dynamicOrder.length - 1;

            // 小型車通過台数グラフ
            const smallDayChartObj = chartInstances.find(chartObj => chartObj.id === 'smallDayChart');
            if (smallDayChartObj) {
                const chart = smallDayChartObj.chart;
                const dataset = chart.data.datasets[0];

                // 背景色を更新 - すべてのバーを青色に設定
                const backgroundColor = Array(7).fill('rgba(54, 162, 235, 0.7)');
                // 最新の曜日（右端）のみ赤色でハイライト
                backgroundColor[latestDayIndex] = 'rgba(255, 99, 132, 0.7)';
                dataset.backgroundColor = backgroundColor;
                chart.update();
            }

            // 大型車通過台数グラフ
            const largeDayChartObj = chartInstances.find(chartObj => chartObj.id === 'largeDayChart');
            if (largeDayChartObj) {
                const chart = largeDayChartObj.chart;
                const dataset = chart.data.datasets[0];

                // 背景色を更新 - すべてのバーを緑色に設定
                const backgroundColor = Array(7).fill('rgba(75, 192, 192, 0.7)');
                // 最新の曜日（右端）のみ赤色でハイライト
                backgroundColor[latestDayIndex] = 'rgba(255, 99, 132, 0.7)';
                dataset.backgroundColor = backgroundColor;
                chart.update();
            }

            // 小型車滞在時間グラフ（折れ線グラフ）
            const smallDayStayTimeChartObj = chartInstances.find(chartObj => chartObj.id === 'smallDayStayTimeChart');
            if (smallDayStayTimeChartObj) {
                const chart = smallDayStayTimeChartObj.chart;
                const dataset = chart.data.datasets[0];

                // ポイントの色を更新（最新の曜日をハイライト）
                if (!Array.isArray(dataset.pointBackgroundColor)) {
                    dataset.pointBackgroundColor = Array(7).fill('rgba(54, 162, 235, 1)');
                    dataset.pointBorderColor = Array(7).fill('#fff');
                }

                for (let i = 0; i < 7; i++) {
                    if (i === latestDayIndex) {
                        // ハイライト色（オレンジ色）
                        dataset.pointBackgroundColor[i] = 'rgba(255, 159, 64, 1)';
                        dataset.pointBorderColor[i] = '#fff';
                        dataset.pointRadius = 6;
                    } else {
                        // 通常色（青色）
                        dataset.pointBackgroundColor[i] = 'rgba(54, 162, 235, 1)';
                        dataset.pointBorderColor[i] = '#fff';
                        dataset.pointRadius = 4;
                    }
                }
                chart.update();
            }

            // 大型車滞在時間グラフ（折れ線グラフ）
            const largeDayStayTimeChartObj = chartInstances.find(chartObj => chartObj.id === 'largeDayStayTimeChart');
            if (largeDayStayTimeChartObj) {
                const chart = largeDayStayTimeChartObj.chart;
                const dataset = chart.data.datasets[0];

                // ポイントの色を更新（最新の曜日をハイライト）
                if (!Array.isArray(dataset.pointBackgroundColor)) {
                    dataset.pointBackgroundColor = Array(7).fill('rgba(75, 192, 192, 1)');
                    dataset.pointBorderColor = Array(7).fill('#fff');
                }

                for (let i = 0; i < 7; i++) {
                    if (i === latestDayIndex) {
                        // ハイライト色（オレンジ色）
                        dataset.pointBackgroundColor[i] = 'rgba(255, 159, 64, 1)';
                        dataset.pointBorderColor[i] = '#fff';
                        dataset.pointRadius = 6;
                    } else {
                        // 通常色（緑色）
                        dataset.pointBackgroundColor[i] = 'rgba(75, 192, 192, 1)';
                        dataset.pointBorderColor[i] = '#fff';
                        dataset.pointRadius = 4;
                    }
                }
                chart.update();
            }

            // 道路交通観測 曜日別表示 小型車通過台数グラフ
            const trafficDaySmallChartObj = chartInstances.find(chartObj => chartObj.id === 'trafficDaySmallChart');
            if (trafficDaySmallChartObj) {
                const chart = trafficDaySmallChartObj.chart;
                const dataset = chart.data.datasets[0];

                // 背景色を更新 - すべてのバーを濃い青色に設定
                const backgroundColor = Array(7).fill('rgba(30, 100, 200, 0.7)');
                // 最新の曜日（右端）のみ紫色でハイライト
                backgroundColor[latestDayIndex] = 'rgba(153, 102, 255, 0.7)';
                dataset.backgroundColor = backgroundColor;
                chart.update();
            }

            // 道路交通観測 曜日別表示 大型車通過台数グラフ
            const trafficDayLargeChartObj = chartInstances.find(chartObj => chartObj.id === 'trafficDayLargeChart');
            if (trafficDayLargeChartObj) {
                const chart = trafficDayLargeChartObj.chart;
                const dataset = chart.data.datasets[0];

                // 背景色を更新 - すべてのバーを濃い緑色に設定
                const backgroundColor = Array(7).fill('rgba(50, 150, 100, 0.7)');
                // 最新の曜日（右端）のみ紫色でハイライト
                backgroundColor[latestDayIndex] = 'rgba(153, 102, 255, 0.7)';
                dataset.backgroundColor = backgroundColor;
                chart.update();
            }

            // ★★★ 追加: 道路交通観測 曜日別表示 小型車平均速度グラフ ★★★
            const averageSpeedDaySmallChartObj = chartInstances.find(chartObj => chartObj.id === 'averageSpeedDaySmallChart');
            if (averageSpeedDaySmallChartObj) {
                const chart = averageSpeedDaySmallChartObj.chart;
                const dataset = chart.data.datasets[0];

                // ポイントの色を更新（最新の曜日をハイライト）
                if (!Array.isArray(dataset.pointBackgroundColor)) {
                    dataset.pointBackgroundColor = Array(7).fill('rgba(54, 162, 235, 1)');
                    dataset.pointBorderColor = Array(7).fill('#fff');
                }

                for (let i = 0; i < 7; i++) {
                    if (i === latestDayIndex) {
                        // ハイライト色（指定された赤色）
                        dataset.pointBackgroundColor[i] = 'rgba(255, 99, 132, 1)';
                        dataset.pointBorderColor[i] = '#fff';
                        dataset.pointRadius = 6;
                    } else {
                        // 通常色（青色）
                        dataset.pointBackgroundColor[i] = 'rgba(54, 162, 235, 1)';
                        dataset.pointBorderColor[i] = '#fff';
                        dataset.pointRadius = 4;
                    }
                }
                chart.update();
            }

            // ★★★ 追加: 道路交通観測 曜日別表示 大型車平均速度グラフ ★★★
            const averageSpeedDayLargeChartObj = chartInstances.find(chartObj => chartObj.id === 'averageSpeedDayLargeChart');
            if (averageSpeedDayLargeChartObj) {
                const chart = averageSpeedDayLargeChartObj.chart;
                const dataset = chart.data.datasets[0];

                // ポイントの色を更新（最新の曜日をハイライト）
                if (!Array.isArray(dataset.pointBackgroundColor)) {
                    dataset.pointBackgroundColor = Array(7).fill('rgba(75, 192, 192, 1)');
                    dataset.pointBorderColor = Array(7).fill('#fff');
                }

                for (let i = 0; i < 7; i++) {
                    if (i === latestDayIndex) {
                        // ハイライト色（指定された赤色）
                        dataset.pointBackgroundColor[i] = 'rgba(255, 99, 132, 1)';
                        dataset.pointBorderColor[i] = '#fff';
                        dataset.pointRadius = 6;
                    } else {
                        // 通常色（緑色）
                        dataset.pointBackgroundColor[i] = 'rgba(75, 192, 192, 1)';
                        dataset.pointBorderColor[i] = '#fff';
                        dataset.pointRadius = 4;
                    }
                }
                chart.update();
            }
        }

        // 時間帯別表示のグラフで0時と12時の色を変更する関数
        function updateTimeBasedColors() {
            chartInstances.forEach(chartObj => {
                const chart = chartObj.chart;
                const datasets = chart.data.datasets;

                // 休憩施設利用状況の時間帯別グラフのみ対象
                const targetCharts = ['smallMainChart', 'largeMainChart', 'smallSubChart', 'largeSubChart'];

                if (targetCharts.includes(chartObj.id) && chart.config.type === 'bar') {
                    datasets.forEach(dataset => {
                        if (!Array.isArray(dataset.backgroundColor)) {
                            // グラフタイプに応じたデフォルト色を設定
                            if (chartObj.id === 'smallMainChart') {
                                dataset.backgroundColor = Array(24).fill('rgba(54, 162, 235, 0.5)'); // 青色
                                dataset.borderColor = Array(24).fill('rgba(54, 162, 235, 1)');
                            } else if (chartObj.id === 'largeMainChart') {
                                dataset.backgroundColor = Array(24).fill('rgba(75, 192, 192, 0.5)'); // 緑色
                                dataset.borderColor = Array(24).fill('rgba(75, 192, 192, 1)');
                            }
                        }

                        // 21時起点のインデックスで0時と12時の位置を特定
                        // 21時起点では:
                        // - 0時はインデックス3 (21→22→23→0)
                        // - 12時はインデックス15 (21→22→23→0→1→2→3→4→5→6→7→8→9→10→11→12)
                        const midnightIndex = 3;  // 0時の位置（21時起点）
                        const noonIndex = 15;     // 12時の位置（21時起点）

                        // 最新の時間帯の色を変更
                        const now = new Date();
                        const currentHour = now.getHours();
                        const shiftedCurrentHour = getShiftedHourIndex(currentHour);

                        for (let i = 0; i < 24; i++) {
                            if (i === midnightIndex) {
                                // 0時は暗い色（濃い青）
                                if (chartObj.id === 'smallMainChart') {
                                    dataset.backgroundColor[i] = 'rgba(26, 0, 102, 0.8)'; // 暗い青色
                                    dataset.borderColor[i] = 'rgba(0, 51, 102, 1)';
                                } else if (chartObj.id === 'largeMainChart') {
                                    dataset.backgroundColor[i] = 'rgba(0, 77, 64, 0.8)'; // 暗い緑色
                                    dataset.borderColor[i] = 'rgba(0, 77, 64, 1)';
                                }
                            } else if (i === noonIndex) {
                                // 12時は明るい色
                                if (chartObj.id === 'smallMainChart') {
                                    dataset.backgroundColor[i] = 'rgba(255, 230, 107, 0.6)'; // 明るい水色
                                    dataset.borderColor[i] = 'rgba(173, 216, 230, 1)';
                                } else if (chartObj.id === 'largeMainChart') {
                                    dataset.backgroundColor[i] = 'rgba(144, 238, 144, 0.9)'; // 明るい緑色
                                    dataset.borderColor[i] = 'rgba(144, 238, 144, 1)';
                                }
                            } else if (i === shiftedCurrentHour) {
                                // 現在時刻は赤色でハイライト（既存の機能を維持）
                                if (chartObj.id === 'smallMainChart' || chartObj.id === 'largeMainChart') {
                                    dataset.backgroundColor[i] = 'rgba(255, 99, 132, 0.7)';
                                    dataset.borderColor[i] = 'rgba(255, 99, 132, 1)';
                                }
                            } else {
                                // 通常の色
                                if (chartObj.id === 'smallMainChart') {
                                    dataset.backgroundColor[i] = 'rgba(54, 162, 235, 0.5)';
                                    dataset.borderColor[i] = 'rgba(54, 162, 235, 1)';
                                } else if (chartObj.id === 'largeMainChart') {
                                    dataset.backgroundColor[i] = 'rgba(75, 192, 192, 0.5)';
                                    dataset.borderColor[i] = 'rgba(75, 192, 192, 1)';
                                }
                            }
                        }
                    });
                }

                // 折れ線グラフの場合（滞在時間グラフ）
                if (targetCharts.includes(chartObj.id) && chart.config.type === 'line') {
                    datasets.forEach(dataset => {
                        if (!Array.isArray(dataset.pointBackgroundColor)) {
                            // グラフタイプに応じたデフォルト色を設定
                            if (chartObj.id === 'smallSubChart') {
                                dataset.pointBackgroundColor = Array(24).fill('rgba(54, 162, 235, 1)'); // 青色
                            } else if (chartObj.id === 'largeSubChart') {
                                dataset.pointBackgroundColor = Array(24).fill('rgba(75, 192, 192, 1)'); // 緑色
                            }
                            dataset.pointBorderColor = Array(24).fill('#fff');
                        }

                        // 21時起点のインデックスで0時と12時の位置を特定
                        const midnightIndex = 3;  // 0時の位置（21時起点）
                        const noonIndex = 15;     // 12時の位置（21時起点）

                        // ハイライトする時間帯を決定（21時起点）
                        const now = new Date();
                        const currentHour = now.getHours();
                        const shiftedCurrentHour = getShiftedHourIndex(currentHour);
                        const highlightHour21Start = shiftedCurrentHour === 0 ? 23 : shiftedCurrentHour - 1;

                        for (let i = 0; i < 24; i++) {
                            if (i === midnightIndex) {
                                // 0時は暗い色
                                if (chartObj.id === 'smallSubChart') {
                                    dataset.pointBackgroundColor[i] = 'rgba(0, 51, 102, 1)'; // 暗い青色
                                } else if (chartObj.id === 'largeSubChart') {
                                    dataset.pointBackgroundColor[i] = 'rgba(0, 77, 64, 1)'; // 暗い緑色
                                }
                                dataset.pointBorderColor[i] = '#fff';
                                dataset.pointRadius = 6;
                            } else if (i === noonIndex) {
                                // 12時は明るい色
                                if (chartObj.id === 'smallSubChart') {
                                    dataset.pointBackgroundColor[i] = 'rgba(173, 216, 230, 1)'; // 明るい水色
                                } else if (chartObj.id === 'largeSubChart') {
                                    dataset.pointBackgroundColor[i] = 'rgba(144, 238, 144, 1)'; // 明るい緑色
                                }
                                dataset.pointBorderColor[i] = '#fff';
                                dataset.pointRadius = 6;
                            } else if (i === highlightHour21Start) {
                                // 最新の時間帯はオレンジ色でハイライト
                                dataset.pointBackgroundColor[i] = 'rgba(255, 159, 64, 1)';
                                dataset.pointBorderColor[i] = '#fff';
                                dataset.pointRadius = 6;
                            } else {
                                // 通常の色
                                if (chartObj.id === 'smallSubChart') {
                                    dataset.pointBackgroundColor[i] = 'rgba(54, 162, 235, 1)';
                                } else if (chartObj.id === 'largeSubChart') {
                                    dataset.pointBackgroundColor[i] = 'rgba(75, 192, 192, 1)';
                                }
                                dataset.pointBorderColor[i] = '#fff';
                                dataset.pointRadius = 4;
                            }
                        }
                    });
                }

                chart.update();
            });
        }

        // 初期化処理
        window.onload = function () {
            // メインタイトルを初期表示
            updateMainTitle();

            // 時間表示の更新を開始
            updateCurrentTime();
            timeUpdateInterval = setInterval(updateCurrentTime, 1000);

            // 初期データの読み込みとグラフの初期化
            Promise.all([
                // 休憩施設利用状況
                // 24時間別データの読み込み
                loadExcelData(),
                loadExcelDataLarge(),
                loadExcelStayTimeData(),
                loadExcelLargeStayTimeData(),
                // 曜日別データの読み込み
                loadExcelDayData(),
                loadExcelDayDataLarge(),
                loadExcelDayStayTimeData(),
                loadExcelDayStayTimeDataLarge(),
                // 道路交通観測
                // 24時間別データの読み込み
                loadExcelTrafficSmallData(),
                loadExcelTrafficLargeData(),
                // 平均速度データの読み込み（道路交通観測）
                loadExcelAverageSpeedSmallData(),
                loadExcelAverageSpeedLargeData(),
                // 曜日別データの読み込み
                loadExcelTrafficDaySmallData(),
                loadExcelTrafficDayLargeData(),
                loadExcelAverageSpeedDaySmallData(),
                loadExcelAverageSpeedDayLargeData()
            ]).then(results => {
                // 結果をlatestDataに保存
                // 休憩施設利用状況
                // 24時間別データ
                chartLatestData.smallInflowsCountByHour = results[0];
                chartLatestData.largeInflowsCountByHour = results[1];
                chartLatestData.smallStayTimeByHour = results[2];
                chartLatestData.largeStayTimeByHour = results[3];
                // 曜日別データ
                chartLatestData.smallInflowsCounByDay = results[4];
                chartLatestData.largeInflowsCountByDay = results[5];
                chartLatestData.smallStayTimeByDay = results[6];
                chartLatestData.largeStayTimeByDay = results[7];
                // 道路交通観測
                // 24時間別データ
                chartLatestData.smallTrafficCountByHour = results[8];
                chartLatestData.largeTrafficCountByHour = results[9];
                chartLatestData.smallAverageSpeedByHour = results[10];
                chartLatestData.largeAverageSpeedByHour = results[11];
                // 曜日別データ
                chartLatestData.smallTrafficCountByDay = results[12];
                chartLatestData.largeTrafficCountByDay = results[13];
                chartLatestData.smallAverageSpeedByDay = results[14];
                chartLatestData.largeAverageSpeedByDay = results[15];

                // 初期グラフの描画
                renderAllCharts();

                // グラフ更新のタイマーを開始
                chartUpdateInterval = setInterval(updateAllCharts, 1000);
            }).catch(error => {
                console.error('データの読み込みに失敗しました:', error);
            });
        };
    </script>
</body>

</html>