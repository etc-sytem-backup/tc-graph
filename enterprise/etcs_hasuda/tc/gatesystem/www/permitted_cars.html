<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>許可車一覧</title>
    <style>
        body {
			font-family: "Meiryo", sans-serif;
			margin: 20px;
			position: relative;
			min-height: 100vh;
			padding-bottom: 80px;
		}
		table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 20px;
		}
		th {
			background-color: #f2f2f2;
			font-weight: bold;
			text-align: center;
		}
		th, td {
			border: 1px solid #ddd;
			padding: 8px;
		}
		.status-in { color: #4CAF50; }
		.status-out { color: #F44336; }
		.checkbox-cell {
			text-align: center;
			width: 50px;
		}
		input[type="checkbox"] {
			transform: scale(1.5);
			margin: 0;
		}
		.button-container {
			position: fixed;
			right: 20px;
			bottom: 20px;
			display: flex;
			gap: 15px;
		}
		.action-button {
			padding: 12px 24px;
			border: none;
			border-radius: 4px;
			font-size: 16px;
			cursor: pointer;
			transition: all 0.3s;
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
		}
		.delete-button {
			background-color: #f44336;
			color: white;
		}
		.register-button {
			background-color: #4CAF50;
			color: white;
		}
		.action-button:hover:not(:disabled) {
			opacity: 0.9;
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
		}
		.action-button:active {
			transform: translateY(0);
		}
		.action-button:disabled {
			background-color: #cccccc;
			cursor: not-allowed;
			opacity: 0.6;
		}
		.modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-actions {
			text-align: right;
			margin-top: 20px;
			display: flex;
			justify-content: flex-end;
			gap: 20px;
		}
		.form-actions button {
			min-width: 100px;
			border-radius: 4px;
			cursor: pointer;
			transition: all 0.3s;
		}
		.form-actions button:hover {
			opacity: 0.9;
			transform: translateY(-2px);
		}
		.form-actions button:active {
			transform: translateY(0);
		}
    </style>
</head>
<body>
    <h1>許可車一覧</h1>
    <a href="/" class="back-btn" style="
        display: inline-block;
        padding: 8px 16px;
        background-color: #FF9800;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        margin-bottom: 20px;
    ">メイン画面に戻る</a>
    <table>
        <thead>
			<tr>
				<th class="checkbox-cell">選択</th>
				<th>ETC車載器番号</th>
				<th>氏名</th>
				<th>部署</th>
				<th>状態</th>
				<th>入場時間</th>
				<th>退場時間</th>
				<th>滞在時間</th>
			</tr>
		</thead>
		<tbody>
			{{range .}}
			<tr>
				<td class="checkbox-cell"><input type="checkbox" class="row-checkbox"></td>
				<td>{{.ETCNumber}}</td>
				<td>{{.Name}}</td>
				<td>{{.Department}}</td>
				<td class="status-{{if eq .Status "入場"}}in{{else}}out{{end}}">{{.Status}}</td>
				<td>{{.EntryTime}}</td>
				<td>{{.ExitTime}}</td>
				<td>{{.StayTime}}</td>
			</tr>
			{{end}}
		</tbody>
    </table>

    <div class="button-container">
        <button class="action-button delete-button" id="deleteButton" disabled>削除</button>
        <button class="action-button register-button" id="registerButton">登録</button>
    </div>

	 <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>新規登録</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="etcNumber">ETC車載器番号:</label>
                    <input type="text" id="etcNumber" required maxlength="12">
                </div>
                <div class="form-group">
                    <label for="name">氏名:</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="department">部署:</label>
                    <input type="text" id="department" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="action-button cancel-button">キャンセル</button>
                    <button type="submit" class="action-button register-button">登録</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const deleteBtn = document.getElementById('deleteButton');
            const checkboxes = document.querySelectorAll('.row-checkbox');
            
            function updateDeleteButton() {
                deleteBtn.disabled = !Array.from(checkboxes).some(cb => cb.checked);
            }

            checkboxes.forEach(cb => cb.addEventListener('change', updateDeleteButton));

            deleteBtn.addEventListener('click', async function() {
                const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                    .map(checkbox => checkbox.closest('tr').cells[1].textContent);

                if (selectedIds.length > 0 && confirm(`${selectedIds.length}件を削除しますか？`)) {
                    try {
                        const response = await fetch('/delete', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `selectedIds=${encodeURIComponent(selectedIds.join(','))}`
                        });
                        
                        if (response.ok) {
                            alert(await response.text());
                            location.reload();
                        }
                    } catch (error) {
                        console.error('削除エラー:', error);
                    }
                }
            });

			// モーダル要素取得
            const modal = document.getElementById("registerModal");
            const registerBtn = document.getElementById("registerButton");
            const closeBtn = document.querySelector(".close");
            const cancelBtn = document.querySelector(".cancel-button");
            const registerForm = document.getElementById("registerForm");

            // 登録ボタンクリックでモーダル表示
            registerBtn.addEventListener('click', function() {
                modal.style.display = "block";
            });

            // 閉じるボタン
            closeBtn.addEventListener('click', function() {
                modal.style.display = "none";
            });

            // キャンセルボタン
            cancelBtn.addEventListener('click', function() {
                modal.style.display = "none";
            });

            // モーダル外クリックで閉じる
            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            });

            // フォーム送信処理
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const etcNumber = document.getElementById("etcNumber").value;
                const name = document.getElementById("name").value;
                const department = document.getElementById("department").value;
                
                console.log("登録情報:", {
                    etcNumber: etcNumber,
                    name: name,
                    department: department
                });
                
                // ここでサーバーにデータを送信
                try {
        			const response = await fetch('/register', {
            			method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded',
						},
						body: new URLSearchParams({
							'etcNumber': etcNumber,
							'name': name,
							'department': department
						})
        			});

					if (!response.ok) {
						throw new Error('サーバーエラー');
					}

					const result = await response.text();
					alert(result);
					modal.style.display = "none";
					registerForm.reset();
					
					// ページをリロードして最新データ表示
					location.reload();
        
    			} catch (error) {
					console.error('登録エラー:', error);
					alert('登録に失敗しました: ' + error.message);
				}

                alert("登録が完了しました");
                modal.style.display = "none";
                registerForm.reset();
            });
        });
    </script>
</body>
</html>